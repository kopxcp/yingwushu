<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人计时器系统</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: all 0.5s ease;
        }

        /* 当前时间显示 */
        .current-time {
            position: fixed;
            top: 20px;
            right: 40px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 1.4rem;
            font-weight: 600;
            color: #fbbf24;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 标题样式 */
        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            padding: 20px;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #fbbf24;
            text-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            letter-spacing: 1px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #94a3b8;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        /* 模式切换器 */
        .mode-switcher {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .mode-btn {
            background: rgba(51, 65, 85, 0.8);
            border: none;
            border-radius: 12px;
            color: #cbd5e1;
            cursor: pointer;
            padding: 20px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 200px;
            justify-content: center;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            background: rgba(71, 85, 105, 0.9);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        .mode-btn i {
            font-size: 1.5rem;
        }

        /* 功能面板 */
        .panel {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            box-shadow:
                    0 20px 40px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-icon {
            font-size: 2rem;
            color: #fbbf24;
        }

        /* 时间显示区域 */
        .timer-display {
            font-size: 3.8rem;
            font-weight: 800;
            text-align: center;
            margin: 25px 0;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 16px;
            padding: 30px 20px;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            box-shadow:
                    inset 0 4px 12px rgba(0, 0, 0, 0.3),
                    0 8px 24px rgba(0, 0, 0, 0.2);
            color: #fbbf24;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            flex-grow: 1;
        }

        /* 秒表时间显示特殊样式 */
        .stopwatch .timer-display {
            font-size: 3.4rem;
        }

        /* 呼吸灯效果 */
        .breathing {
            animation: breathing 2s infinite ease-in-out;
        }

        @keyframes breathing {
            0% {
                box-shadow:
                        inset 0 4px 12px rgba(0, 0, 0, 0.3),
                        0 8px 24px rgba(0, 0, 0, 0.2),
                        0 0 20px rgba(251, 191, 36, 0.1);
            }
            50% {
                box-shadow:
                        inset 0 4px 12px rgba(0, 0, 0, 0.3),
                        0 8px 24px rgba(0, 0, 0, 0.2),
                        0 0 40px rgba(251, 191, 36, 0.3);
            }
            100% {
                box-shadow:
                        inset 0 4px 12px rgba(0, 0, 0, 0.3),
                        0 8px 24px rgba(0, 0, 0, 0.2),
                        0 0 20px rgba(251, 191, 36, 0.1);
            }
        }

        /* 计时器控制区域 */
        .timer-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        /* 大型开始按钮 */
        .start-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            padding: 22px 32px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 180px;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .start-btn:hover {
            background: linear-gradient(135deg, #34d399, #10b981);
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
        }

        .start-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .start-btn.running {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .start-btn i {
            font-size: 2rem;
        }

        /* 其他控制按钮 */
        .control-btn {
            background: rgba(51, 65, 85, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            padding: 16px 22px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 140px;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            background: rgba(71, 85, 105, 0.9);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .reset-btn:hover {
            background: linear-gradient(135deg, #f87171, #ef4444);
        }

        .lap-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .lap-btn:hover {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
        }

        .add-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #34d399, #10b981);
        }

        .record-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .record-btn:hover {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        }

        .history-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .history-btn:hover {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        /* 时间设置区域 */
        .time-setter {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .time-setter-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .time-setter-label {
            font-size: 1rem;
            color: #94a3b8;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .time-input {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #fbbf24;
            font-size: 1.4rem;
            font-family: 'Courier New', monospace;
            width: 100px;
            text-align: center;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .time-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
        }

        /* 成绩表格样式 */
        .results-table-container {
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
            flex-grow: 1;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table-container h3 {
            font-size: 1.3rem;
            color: #fbbf24;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 0.5px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            background-color: rgba(30, 41, 59, 0.9);
            padding: 14px 16px;
            text-align: left;
            color: #fbbf24;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-family: 'Courier New', monospace;
        }

        .results-table tr:hover {
            background-color: rgba(251, 191, 36, 0.05);
        }

        .player-name {
            font-weight: 600;
            color: #e2e8f0;
        }

        .player-time {
            font-weight: 700;
            color: #fbbf24;
            font-size: 1.1rem;
        }

        .best-time {
            color: #10b981;
            font-weight: 700;
        }

        .rank-cell {
            font-weight: 800;
            font-size: 1.2rem;
            text-align: center;
            width: 50px;
        }

        .rank-1 { color: #fbbf24; } /* 金色 */
        .rank-2 { color: #cbd5e1; } /* 银色 */
        .rank-3 { color: #b45309; } /* 铜色 */
        .rank-other { color: #94a3b8; }

        .time-entry {
            color: #fbbf24;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .time-entry-list {
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 6px;
            margin-top: 5px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .time-entry-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .time-entry-item:last-child {
            border-bottom: none;
        }

        .time-entry-number {
            color: #94a3b8;
            font-size: 0.85rem;
            min-width: 30px;
        }

        .current-player {
            background-color: rgba(251, 191, 36, 0.08) !important;
        }

        /* 历史成绩表格样式 */
        .history-table-container {
            margin-top: 25px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            flex-grow: 1;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table-container h3 {
            font-size: 1.3rem;
            color: #fbbf24;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 0.5px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background-color: rgba(30, 41, 59, 0.9);
            padding: 14px 16px;
            text-align: left;
            color: #fbbf24;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-family: 'Courier New', monospace;
        }

        .history-table tr:hover {
            background-color: rgba(251, 191, 36, 0.05);
        }

        .session-time {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .session-header {
            background: rgba(30, 41, 59, 0.8) !important;
            font-weight: 700;
            color: #fbbf24;
            border-top: 2px solid rgba(251, 191, 36, 0.3);
        }

        /* 空状态消息 */
        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            font-size: 1.1rem;
        }

        /* 参与者管理区域 */
        .participants-management {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .participants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .participants-title {
            font-size: 1.2rem;
            color: #fbbf24;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .participant-input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .participant-input {
            flex: 1;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: #e2e8f0;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .participant-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
        }

        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 70px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .participants-list.ui-sortable {
            min-height: 80px;
            padding: 12px;
        }

        .participants-list.ui-sortable.sorting-active {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .participant-tag {
            background: rgba(51, 65, 85, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            user-select: none;
        }

        .participant-tag:hover {
            transform: translateY(-2px);
            background: rgba(71, 85, 105, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .participant-tag.selected {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .participant-tag.dragging {
            opacity: 0.9;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 改进拖拽样式 */
        .participant-tag.ui-sortable-helper {
            transform: rotate(3deg) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000 !important;
        }

        .ui-sortable-placeholder {
            background: rgba(251, 191, 36, 0.1) !important;
            border: 2px dashed rgba(251, 191, 36, 0.3) !important;
            border-radius: 20px;
            visibility: visible !important;
            height: 40px !important;
            margin: 5px 0;
        }

        .drag-handle {
            cursor: move;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-right: 5px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .drag-handle:hover {
            color: #fbbf24;
            opacity: 1;
            transform: scale(1.1);
        }

        .participant-tag:hover .drag-handle {
            opacity: 0.8;
        }

        /* 添加拖拽提示 */
        .participants-list:empty:after {
            content: "拖拽参与者标签可重新排序";
            display: block;
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 15px;
            font-size: 0.9rem;
            width: 100%;
        }

        .participants-list.ui-sortable:empty:after {
            content: "添加参与者后，可拖拽标签重新排序";
        }

        .participant-tag .remove-btn {
            background: none;
            border: none;
            color: #f87171;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            margin-left: 5px;
        }

        .participant-tag .remove-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* 状态指示器 */
        .status-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #475569;
            transition: all 0.3s ease;
        }

        .status-dot.active {
            background-color: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
        }

        .status-text {
            font-size: 1rem;
            color: #cbd5e1;
            font-weight: 600;
        }

        /* 全屏按钮 */
        .fullscreen-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fbbf24;
            cursor: pointer;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .fullscreen-toggle:hover {
            transform: translateY(-2px);
            background: rgba(51, 65, 85, 0.9);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-toggle.active {
            background: rgba(51, 65, 85, 0.9);
        }

        /* 隐藏面板 */
        .hidden {
            display: none !important;
        }

        /* 历史成绩模态框 */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .history-modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transform: translateY(30px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-modal.active .history-modal-content {
            transform: translateY(0);
        }

        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-modal-title {
            font-size: 1.8rem;
            color: #fbbf24;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-modal-close {
            background: none;
            border: none;
            color: #fbbf24;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .history-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        /* 历史成绩标签页 */
        .history-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-tab {
            background: rgba(51, 65, 85, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #cbd5e1;
            cursor: pointer;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .history-tab:hover {
            background: rgba(71, 85, 105, 0.9);
            transform: translateY(-2px);
        }

        .history-tab.active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .history-tab-content {
            display: none;
        }

        .history-tab-content.active {
            display: block;
        }

        /* 多人同时计时圈数记录区域 */
        .multi-lap-container {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .multi-lap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .multi-lap-title {
            font-size: 1.2rem;
            color: #fbbf24;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-lap-controls {
            display: flex;
            gap: 10px;
        }

        .multi-lap-table-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .multi-lap-table {
            width: 100%;
            border-collapse: collapse;
        }

        .multi-lap-table th {
            background-color: rgba(30, 41, 59, 0.9);
            padding: 14px 16px;
            text-align: left;
            color: #fbbf24;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .multi-lap-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-family: 'Courier New', monospace;
        }

        .multi-lap-table tr:hover {
            background-color: rgba(251, 191, 36, 0.05);
        }

        .lap-rank {
            font-weight: 700;
            font-size: 1.2rem;
            width: 50px;
            text-align: center;
        }

        .lap-rank-1 { color: #fbbf24; }
        .lap-rank-2 { color: #cbd5e1; }
        .lap-rank-3 { color: #b45309; }

        .participant-select {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e2e8f0;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            width: 100%;
            transition: all 0.3s ease;
        }

        .participant-select:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
        }

        .save-lap-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .save-lap-btn:hover {
            background: linear-gradient(135deg, #34d399, #10b981);
            transform: translateY(-2px);
        }

        .delete-lap-btn {
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-lap-btn:hover {
            background: rgba(248, 113, 113, 0.9);
            transform: translateY(-2px);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }

            .timer-display {
                font-size: 3rem;
                padding: 25px 15px;
                min-height: 140px;
                letter-spacing: 1px;
            }

            .stopwatch .timer-display {
                font-size: 2.6rem;
            }

            .start-btn {
                padding: 18px 24px;
                font-size: 1.3rem;
                min-width: 150px;
            }

            .control-btn {
                padding: 14px 18px;
                font-size: 1rem;
                min-width: 120px;
            }

            .time-setter {
                flex-direction: column;
                gap: 15px;
            }

            .mode-btn {
                padding: 16px 20px;
                font-size: 1.1rem;
                min-width: 160px;
            }

            .fullscreen-toggle {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .participant-input-row {
                flex-direction: column;
            }

            .results-table, .history-table, .multi-lap-table {
                font-size: 0.9rem;
            }

            .history-tabs {
                flex-direction: column;
            }

            .time-entry-list {
                max-height: 80px;
            }
        }

        @media (max-width: 480px) {
            .timer-display {
                font-size: 2.4rem;
                letter-spacing: 1px;
            }

            .stopwatch .timer-display {
                font-size: 2.1rem;
            }

            .timer-controls {
                flex-direction: column;
                align-items: center;
            }

            .start-btn, .control-btn {
                width: 100%;
            }

            .mode-btn {
                min-width: 140px;
                padding: 14px 16px;
                font-size: 1rem;
            }

            .time-input {
                width: 80px;
                font-size: 1.2rem;
            }
        }

        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .blink {
            animation: blink 1s infinite;
        }

        /* 全屏模式样式 */
        .fullscreen-mode {
            width: 100vw;
            height: 100vh;
            max-width: none;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
            background: #0f172a;
            overflow: auto;
        }

        .fullscreen-mode .timer-display {
            font-size: 5rem;
            min-height: 200px;
        }

        .fullscreen-mode .start-btn {
            font-size: 2rem;
            padding: 25px 35px;
        }

        .fullscreen-mode .control-btn {
            font-size: 1.4rem;
            padding: 20px 25px;
        }
    </style>
</head>
<body>

<!-- 当前时间显示 -->
<div class="current-time">
    <i class="fas fa-clock"></i>
    <span id="current-time-display">00:00:00</span>
</div>

<!-- 全屏按钮 -->
<button class="fullscreen-toggle" id="fullscreen-toggle">
    <i class="fas fa-expand"></i>
    <span>全屏模式</span>
</button>

<!-- 历史成绩模态框 -->
<div class="history-modal" id="history-modal">
    <div class="history-modal-content">
        <div class="history-modal-header">
            <h2 class="history-modal-title"><i class="fas fa-history"></i> 历史成绩记录</h2>
            <button class="history-modal-close" id="history-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="history-tabs" id="history-tabs">
            <button class="history-tab active" data-tab="timer-history">倒计时历史</button>
            <button class="history-tab" data-tab="stopwatch-history">秒表历史</button>
        </div>

        <div class="history-tab-content active" id="timer-history-content">
            <h3><i class="fas fa-stopwatch"></i> 倒计时历史成绩</h3>
            <div class="history-table-container">
                <table class="history-table" id="timer-history-table">
                    <thead>
                    <tr>
                        <th width="10%">局数</th>
                        <th width="15%">时间</th>
                        <th width="10%">名次</th>
                        <th width="20%">参与者</th>
                        <th width="25%">所有成绩</th>
                        <th width="20%">最好成绩</th>
                    </tr>
                    </thead>
                    <tbody id="timer-history-body">
                    <!-- 倒计时历史记录将通过JavaScript动态添加 -->
                    </tbody>
                </table>
                <div id="timer-history-empty" class="empty-message">暂无历史成绩记录</div>
            </div>
        </div>

        <div class="history-tab-content" id="stopwatch-history-content">
            <h3><i class="fas fa-running"></i> 秒表历史成绩</h3>
            <div class="history-table-container">
                <table class="history-table" id="stopwatch-history-table">
                    <thead>
                    <tr>
                        <th width="10%">局数</th>
                        <th width="15%">时间</th>
                        <th width="10%">名次</th>
                        <th width="20%">参与者</th>
                        <th width="25%">所有成绩</th>
                        <th width="20%">最好成绩</th>
                    </tr>
                    </thead>
                    <tbody id="stopwatch-history-body">
                    <!-- 秒表历史记录将通过JavaScript动态添加 -->
                    </tbody>
                </table>
                <div id="stopwatch-history-empty" class="empty-message">暂无历史成绩记录</div>
            </div>
        </div>
    </div>
</div>

<div class="container" id="main-container">
    <header>
        <h1><i class="fas fa-clock"></i> 多人计时器系统</h1>
        <p class="subtitle">支持多人成绩记录与历史查看的计时系统</p>
    </header>

    <!-- 模式切换器 -->
    <div class="mode-switcher">
        <button class="mode-btn active" id="timer-mode-btn">
            <i class="fas fa-hourglass-half"></i>
            <span>倒计时模式</span>
        </button>
        <button class="mode-btn" id="stopwatch-mode-btn">
            <i class="fas fa-running"></i>
            <span>秒表模式</span>
        </button>
    </div>

    <!-- 倒计时模式面板 -->
    <div class="panel timer" id="timer-panel">
        <div class="panel-header">
            <h2 class="panel-title"><i class="fas fa-hourglass-half"></i> 倒计时模式</h2>
            <div class="panel-icon">
                <i class="fas fa-stopwatch"></i>
            </div>
        </div>

        <!-- 时间显示区域 -->
        <div class="timer-display" id="timer-display">
            00:10:00
        </div>

        <!-- 状态指示器 -->
        <div class="status-indicator">
            <div class="status-dot" id="timer-status-dot"></div>
            <span class="status-text" id="timer-status-text">准备就绪</span>
        </div>

        <!-- 时间设置区域 -->
        <div class="time-setter" id="timer-setter">
            <div class="time-setter-item">
                <span class="time-setter-label">小时</span>
                <input type="number" class="time-input" id="timer-hours" min="0" max="99" value="0">
            </div>
            <div class="time-setter-item">
                <span class="time-setter-label">分钟</span>
                <input type="number" class="time-input" id="timer-minutes" min="0" max="59" value="10">
            </div>
            <div class="time-setter-item">
                <span class="time-setter-label">秒钟</span>
                <input type="number" class="time-input" id="timer-seconds" min="0" max="59" value="0">
            </div>
        </div>

        <!-- 参与者管理区域 -->
        <div class="participants-management">
            <div class="participants-header">
                <div class="participants-title">
                    <i class="fas fa-user-friends"></i> 参与者管理
                </div>
            </div>
            <div class="participant-input-row">
                <input type="text" class="participant-input" id="timer-participant-input" placeholder="输入参与者姓名" maxlength="20">
                <button class="control-btn add-btn" id="timer-add-participant-btn">
                    <i class="fas fa-plus"></i>
                    <span>添加</span>
                </button>
            </div>
            <div class="participants-list" id="timer-participants-list">
                <!-- 参与者标签将通过JavaScript动态添加 -->
            </div>
        </div>

        <!-- 控制按钮区域 -->
        <div class="timer-controls">
            <button class="start-btn" id="timer-start-btn">
                <i class="fas fa-play"></i>
                <span>开始计时</span>
            </button>
            <button class="control-btn reset-btn" id="timer-reset-btn">
                <i class="fas fa-redo"></i>
                <span>重置本局</span>
            </button>
            <button class="control-btn lap-btn" id="next-participant-btn">
                <i class="fas fa-forward"></i>
                <span>下一位</span>
            </button>
            <button class="control-btn history-btn" id="timer-history-btn">
                <i class="fas fa-history"></i>
                <span>历史成绩</span>
            </button>
        </div>

        <!-- 成绩表格区域 -->
        <div class="results-table-container">
            <h3><i class="fas fa-trophy"></i> 本局成绩记录</h3>
            <table class="results-table" id="timer-results-table">
                <thead>
                <tr>
                    <th width="10%">名次</th>
                    <th width="20%">姓名</th>
                    <th width="35%">所有成绩</th>
                    <th width="20%">最好成绩</th>
                    <th width="15%">测试次数</th>
                </tr>
                </thead>
                <tbody id="timer-results-body">
                <!-- 成绩记录将通过JavaScript动态添加 -->
                </tbody>
            </table>
            <div id="timer-empty-results-message" class="empty-message">暂无成绩记录，添加参与者并开始计时</div>
        </div>
    </div>

    <!-- 秒表模式面板 -->
    <div class="panel stopwatch hidden" id="stopwatch-panel">
        <div class="panel-header">
            <h2 class="panel-title"><i class="fas fa-running"></i> 秒表模式</h2>
            <div class="panel-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
        </div>

        <!-- 时间显示区域 -->
        <div class="timer-display" id="stopwatch-display">
            00:00:00.000
        </div>

        <!-- 状态指示器 -->
        <div class="status-indicator">
            <div class="status-dot" id="stopwatch-status-dot"></div>
            <span class="status-text" id="stopwatch-status-text">准备就绪</span>
        </div>

        <!-- 参与者管理区域 -->
        <div class="participants-management">
            <div class="participants-header">
                <div class="participants-title">
                    <i class="fas fa-user-friends"></i> 参与者管理
                </div>
            </div>
            <div class="participant-input-row">
                <input type="text" class="participant-input" id="stopwatch-participant-input" placeholder="输入参与者姓名" maxlength="20">
                <button class="control-btn add-btn" id="stopwatch-add-participant-btn">
                    <i class="fas fa-plus"></i>
                    <span>添加</span>
                </button>
            </div>
            <div class="participants-list" id="stopwatch-participants-list">
                <!-- 参与者标签将通过JavaScript动态添加 -->
            </div>
        </div>

        <!-- 控制按钮区域 -->
        <div class="timer-controls">
            <button class="start-btn" id="stopwatch-start-btn">
                <i class="fas fa-play"></i>
                <span>开始计时</span>
            </button>
            <button class="control-btn record-btn" id="record-time-btn">
                <i class="fas fa-flag-checkered"></i>
                <span>记录成绩</span>
            </button>
            <button class="control-btn lap-btn" id="stopwatch-lap-btn">
                <i class="fas fa-flag"></i>
                <span>记录名次</span>
            </button>
            <button class="control-btn reset-btn" id="stopwatch-reset-btn">
                <i class="fas fa-redo"></i>
                <span>重置本局</span>
            </button>
            <button class="control-btn history-btn" id="stopwatch-history-btn">
                <i class="fas fa-history"></i>
                <span>历史成绩</span>
            </button>
        </div>

        <!-- 成绩表格区域 -->
        <div class="results-table-container">
            <h3><i class="fas fa-trophy"></i> 本局成绩记录</h3>
            <table class="results-table" id="stopwatch-results-table">
                <thead>
                <tr>
                    <th width="10%">名次</th>
                    <th width="20%">姓名</th>
                    <th width="35%">所有成绩</th>
                    <th width="20%">最好成绩</th>
                    <th width="15%">测试次数</th>
                </tr>
                </thead>
                <tbody id="stopwatch-results-body">
                <!-- 成绩记录将通过JavaScript动态添加 -->
                </tbody>
            </table>
            <div id="stopwatch-empty-results-message" class="empty-message">暂无成绩记录，添加参与者并开始计时</div>
        </div>

        <!-- 多人同时计时圈数记录区域 -->
        <div class="multi-lap-container">
            <div class="multi-lap-header">
                <h3 class="multi-lap-title"><i class="fas fa-medal"></i> 多人同时计时名次记录</h3>
                <div class="multi-lap-controls">
                    <button class="save-lap-btn" id="save-all-laps-btn">
                        <i class="fas fa-save"></i>
                        <span>保存所有成绩</span>
                    </button>
                    <button class="delete-lap-btn" id="clear-multi-lap-btn">
                        <i class="fas fa-trash"></i>
                        <span>清空名次</span>
                    </button>
                </div>
            </div>
            <div class="multi-lap-table-container">
                <table class="multi-lap-table" id="multi-lap-table">
                    <thead>
                    <tr>
                        <th width="10%">名次</th>
                        <th width="25%">时间</th>
                        <th width="40%">参与者</th>
                        <th width="25%">操作</th>
                    </tr>
                    </thead>
                    <tbody id="multi-lap-body">
                    <!-- 多人同时计时记录将通过JavaScript动态添加 -->
                    </tbody>
                </table>
                <div id="multi-lap-empty-message" class="empty-message">
                    <p>暂无名次记录</p>
                    <p>使用方法：</p>
                    <p>1. 点击"开始计时"开始多人同时计时</p>
                    <p>2. 当选手完成时，点击"记录名次"记录当前时间</p>
                    <p>3. 为每个名次选择对应的参与者</p>
                    <p>4. 点击"保存所有成绩"保存本轮所有成绩</p>
                </div>
            </div>
        </div>
    </div>

    <footer style="margin-top: 30px; text-align: center; color: #94a3b8; font-size: 0.9rem; padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); width: 100%;">
        <p>© 2023 多人计时器系统 | 专业运动计时系统</p>
        <p>支持多人成绩记录与历史查看，所有数据实时保存</p>
    </footer>
</div>

<script>
    $(document).ready(function() {
        console.log("开始初始化应用...");

        // 初始化变量
        let currentMode = 'timer';
        let isFullscreen = false;

        // 倒计时模式相关变量
        let timerInterval = null;
        let timerRunning = false;
        let timerTimeLeft = 600;
        let timerTotalTime = 600;
        let timerStartTime = 0;
        let timerElapsedTime = 0;

        // 倒计时参与者管理
        let timerParticipants = [];
        let timerCurrentParticipantIndex = -1;
        let timerParticipantResults = {}; // 所有历史成绩
        let timerAllSessions = []; // 存储所有历史会话
        let timerCurrentSessionResults = {}; // 当前局成绩（重置时会清空）

        // 秒表模式相关变量
        let stopwatchInterval = null;
        let stopwatchRunning = false;
        let stopwatchTime = 0;
        let stopwatchStartTime = 0;

        // 秒表参与者管理
        let stopwatchParticipants = [];
        let stopwatchCurrentParticipantIndex = -1;
        let stopwatchParticipantResults = {}; // 所有历史成绩
        let stopwatchAllSessions = []; // 存储所有历史会话
        let stopwatchCurrentSessionResults = {}; // 当前局成绩（重置时会清空）

        // 多人同时计时记录
        let multiLapRecords = [];

        // localStorage存储键名
        const STORAGE_KEYS = {
            TIMER_PARTICIPANTS: 'multi_timer_participants_v7',
            TIMER_RESULTS: 'multi_timer_results_v7',
            TIMER_SESSIONS: 'multi_timer_sessions_v7',
            STOPWATCH_PARTICIPANTS: 'multi_stopwatch_participants_v7',
            STOPWATCH_RESULTS: 'multi_stopwatch_results_v7',
            STOPWATCH_SESSIONS: 'multi_stopwatch_sessions_v7'
        };

        // 缓存jQuery对象
        const $currentTimeDisplay = $('#current-time-display');
        const $fullscreenToggle = $('#fullscreen-toggle');
        const $mainContainer = $('#main-container');
        const $timerPanel = $('#timer-panel');
        const $stopwatchPanel = $('#stopwatch-panel');
        const $timerDisplay = $('#timer-display');
        const $timerStatusDot = $('#timer-status-dot');
        const $timerStatusText = $('#timer-status-text');
        const $timerHours = $('#timer-hours');
        const $timerMinutes = $('#timer-minutes');
        const $timerSeconds = $('#timer-seconds');
        const $timerStartBtn = $('#timer-start-btn');
        const $timerResetBtn = $('#timer-reset-btn');
        const $nextParticipantBtn = $('#next-participant-btn');
        const $timerHistoryBtn = $('#timer-history-btn');
        const $timerSetter = $('#timer-setter');
        const $timerParticipantInput = $('#timer-participant-input');
        const $timerAddParticipantBtn = $('#timer-add-participant-btn');
        const $timerParticipantsList = $('#timer-participants-list');
        const $timerResultsBody = $('#timer-results-body');
        const $timerResultsTable = $('#timer-results-table');
        const $timerEmptyResultsMessage = $('#timer-empty-results-message');
        const $stopwatchDisplay = $('#stopwatch-display');
        const $stopwatchStatusDot = $('#stopwatch-status-dot');
        const $stopwatchStatusText = $('#stopwatch-status-text');
        const $stopwatchStartBtn = $('#stopwatch-start-btn');
        const $recordTimeBtn = $('#record-time-btn');
        const $stopwatchLapBtn = $('#stopwatch-lap-btn');
        const $stopwatchResetBtn = $('#stopwatch-reset-btn');
        const $stopwatchHistoryBtn = $('#stopwatch-history-btn');
        const $stopwatchParticipantInput = $('#stopwatch-participant-input');
        const $stopwatchAddParticipantBtn = $('#stopwatch-add-participant-btn');
        const $stopwatchParticipantsList = $('#stopwatch-participants-list');
        const $stopwatchResultsBody = $('#stopwatch-results-body');
        const $stopwatchResultsTable = $('#stopwatch-results-table');
        const $stopwatchEmptyResultsMessage = $('#stopwatch-empty-results-message');
        const $multiLapBody = $('#multi-lap-body');
        const $multiLapEmptyMessage = $('#multi-lap-empty-message');
        const $multiLapTable = $('#multi-lap-table');
        const $clearMultiLapBtn = $('#clear-multi-lap-btn');
        const $saveAllLapsBtn = $('#save-all-laps-btn');
        const $historyModal = $('#history-modal');
        const $historyModalClose = $('#history-modal-close');
        const $historyTabs = $('#history-tabs');
        const $timerHistoryBody = $('#timer-history-body');
        const $stopwatchHistoryBody = $('#stopwatch-history-body');
        const $timerHistoryEmpty = $('#timer-history-empty');
        const $stopwatchHistoryEmpty = $('#stopwatch-history-empty');
        const $timerModeBtn = $('#timer-mode-btn');
        const $stopwatchModeBtn = $('#stopwatch-mode-btn');

        // ==================== 工具函数 ====================

        // localStorage操作函数
        function saveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('保存到localStorage失败:', key, e);
                return false;
            }
        }

        function loadFromStorageByKey(key) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            } catch (e) {
                console.error('从localStorage加载失败:', key, e);
                return null;
            }
        }

        function removeFromStorage(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('从localStorage移除失败:', key, e);
            }
        }

        // 时间格式化函数
        function formatTimeFromSeconds(totalSeconds) {
            try {
                if (typeof totalSeconds !== 'number' || isNaN(totalSeconds)) {
                    return "00:00.000";
                }

                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const milliseconds = Math.floor((totalSeconds * 1000) % 1000);

                const formattedHours = hours.toString().padStart(2, '0');
                const formattedMinutes = minutes.toString().padStart(2, '0');
                const formattedSeconds = seconds.toString().padStart(2, '0');
                const formattedMilliseconds = milliseconds.toString().padStart(3, '0');

                if (hours > 0) {
                    return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
                } else if (minutes > 0) {
                    return `${formattedMinutes}:${formattedSeconds}.${formattedMilliseconds}`;
                } else {
                    return `${formattedSeconds}.${formattedMilliseconds}`;
                }
            } catch (error) {
                console.error("格式化时间失败:", error);
                return "00:00.000";
            }
        }

        function formatTimeFromMilliseconds(totalMilliseconds) {
            return formatTimeFromSeconds(totalMilliseconds / 1000);
        }

        // 生成成绩HTML
        function generateTimesHTML(times) {
            if (!times || times.length === 0) {
                return '<span style="color: #94a3b8; font-style: italic;">暂无成绩</span>';
            }

            let html = '<div class="time-entry-list">';
            times.forEach((time, idx) => {
                const formattedTime = formatTimeFromSeconds(time);
            html += `
                    <div class="time-entry-item">
                        <span class="time-entry-number">${idx + 1}.</span>
                        <span class="time-entry">${formattedTime}</span>
                    </div>
                `;
        });
            html += '</div>';
            return html;
        }

        // 生成历史记录行的成绩HTML
        function generateHistoryTimesHTML(times) {
            if (!times || times.length === 0) {
                return '<span style="color: #94a3b8; font-style: italic;">无成绩</span>';
            }

            let html = '<div class="time-entry-list" style="max-height: 80px;">';
            times.forEach((time, idx) => {
                const formattedTime = formatTimeFromSeconds(time);
            html += `
                    <div class="time-entry-item">
                        <span class="time-entry-number">${idx + 1}.</span>
                        <span class="time-entry">${formattedTime}</span>
                    </div>
                `;
        });
            html += '</div>';
            return html;
        }

        // 获取名次类
        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }

        // 获取圈数名次类
        function getLapRankClass(rank) {
            if (rank === 1) return 'lap-rank-1';
            if (rank === 2) return 'lap-rank-2';
            if (rank === 3) return 'lap-rank-3';
            return '';
        }

        // 计算当前局名次
        function calculateRankInSession(name, sessionResults) {
            const participantsWithTimes = [];

            Object.keys(sessionResults).forEach(participantName => {
                const times = sessionResults[participantName] || [];
            if (times.length > 0) {
                const bestTime = Math.min(...times);
                participantsWithTimes.push({
                    name: participantName,
                    bestTime: bestTime
                });
            }
        });

            // 按最好成绩排序
            participantsWithTimes.sort((a, b) => a.bestTime - b.bestTime);

            // 查找名次
            const rank = participantsWithTimes.findIndex(p => p.name === name) + 1;
            return rank > 0 ? rank : null;
        }

        // ==================== 数据管理函数 ====================

        // 保存数据到localStorage
        function saveTimerData() {
            saveToStorage(STORAGE_KEYS.TIMER_PARTICIPANTS, timerParticipants);
            saveToStorage(STORAGE_KEYS.TIMER_RESULTS, timerParticipantResults);
            saveToStorage(STORAGE_KEYS.TIMER_SESSIONS, timerAllSessions);
        }

        function saveStopwatchData() {
            saveToStorage(STORAGE_KEYS.STOPWATCH_PARTICIPANTS, stopwatchParticipants);
            saveToStorage(STORAGE_KEYS.STOPWATCH_RESULTS, stopwatchParticipantResults);
            saveToStorage(STORAGE_KEYS.STOPWATCH_SESSIONS, stopwatchAllSessions);
        }

        // 从localStorage加载数据
        function loadFromStorage() {
            console.log("开始从localStorage加载数据...");

            // 加载倒计时数据
            const timerParticipantsData = loadFromStorageByKey(STORAGE_KEYS.TIMER_PARTICIPANTS);
            const timerResultsData = loadFromStorageByKey(STORAGE_KEYS.TIMER_RESULTS);
            const timerSessionsData = loadFromStorageByKey(STORAGE_KEYS.TIMER_SESSIONS);

            // 加载秒表数据
            const stopwatchParticipantsData = loadFromStorageByKey(STORAGE_KEYS.STOPWATCH_PARTICIPANTS);
            const stopwatchResultsData = loadFromStorageByKey(STORAGE_KEYS.STOPWATCH_RESULTS);
            const stopwatchSessionsData = loadFromStorageByKey(STORAGE_KEYS.STOPWATCH_SESSIONS);

            // 处理倒计时参与者数据
            if (timerParticipantsData && Array.isArray(timerParticipantsData)) {
                timerParticipants = timerParticipantsData.filter(name =>
                    typeof name === 'string' && name.trim() !== ''
            );
                console.log("加载倒计时参与者:", timerParticipants);
            } else {
                timerParticipants = [];
            }

            // 处理倒计时成绩数据
            if (timerResultsData && typeof timerResultsData === 'object') {
                timerParticipantResults = timerResultsData;
            } else {
                timerParticipantResults = {};
            }

            // 处理倒计时历史会话数据
            if (timerSessionsData && Array.isArray(timerSessionsData)) {
                timerAllSessions = timerSessionsData;
            } else {
                timerAllSessions = [];
            }

            // 处理秒表参与者数据
            if (stopwatchParticipantsData && Array.isArray(stopwatchParticipantsData)) {
                stopwatchParticipants = stopwatchParticipantsData.filter(name =>
                    typeof name === 'string' && name.trim() !== ''
            );
                console.log("加载秒表参与者:", stopwatchParticipants);
            } else {
                stopwatchParticipants = [];
            }

            // 处理秒表成绩数据
            if (stopwatchResultsData && typeof stopwatchResultsData === 'object') {
                stopwatchParticipantResults = stopwatchResultsData;
            } else {
                stopwatchParticipantResults = {};
            }

            // 处理秒表历史会话数据
            if (stopwatchSessionsData && Array.isArray(stopwatchSessionsData)) {
                stopwatchAllSessions = stopwatchSessionsData;
            } else {
                stopwatchAllSessions = [];
            }

            console.log("数据加载完成");
        }

        // 重置所有数据
        function resetAllData() {
            console.log("重置所有数据...");
            timerParticipants = [];
            timerParticipantResults = {};
            timerAllSessions = [];
            timerCurrentSessionResults = {};
            stopwatchParticipants = [];
            stopwatchParticipantResults = {};
            stopwatchAllSessions = [];
            stopwatchCurrentSessionResults = {};
            multiLapRecords = [];

            for (let key in STORAGE_KEYS) {
                removeFromStorage(STORAGE_KEYS[key]);
            }
        }

        // 紧急重置
        function emergencyReset() {
            console.log("执行紧急重置...");
            resetAllData();
            updateTimerParticipantsList();
            updateStopwatchParticipantsList();
            updateTimerResultsTable();
            updateStopwatchResultsTable();
            updateMultiLapTable();
            alert("系统已重置，请重新开始使用。");
        }

        // ==================== 参与者管理函数 ====================

        // 通用参与者添加函数
        function addParticipant(participants, results, name, isTimer = true) {
            if (!name || name.trim() === '') {
                alert('参与者姓名不能为空！');
                return false;
            }

            if (participants.includes(name)) {
                alert('该参与者已存在！');
                return false;
            }

            participants.push(name);

            if (!results[name]) {
                results[name] = {
                    times: [],
                    bestTime: null
                };
            }

            return true;
        }

        // 通用参与者移除函数
        function removeParticipant(participants, results, currentIndex, name, isTimer = true) {
            const index = participants.indexOf(name);
            if (index > -1) {
                participants.splice(index, 1);

                // 更新当前索引
                if (currentIndex >= participants.length) {
                    currentIndex = participants.length - 1;
                }

                if (currentIndex === index) {
                    currentIndex = participants.length > 0 ? 0 : -1;
                } else if (currentIndex > index) {
                    currentIndex--;
                }

                delete results[name];

                return currentIndex;
            }
            return currentIndex;
        }

        // 通用参与者列表更新函数
        function updateParticipantsList($list, participants, currentIndex, isTimer = true) {
            try {
                $list.empty();

                participants.forEach((name, index) => {
                    if (!name || typeof name !== 'string') return;

                const $tag = $(`
                        <div class="participant-tag ${currentIndex === index ? 'selected' : ''}">
                            <div class="drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <span>${name}</span>
                            <button class="remove-btn" data-name="${name}" title="移除">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `);

                $tag.find('.remove-btn').on('click', function(e) {
                    e.stopPropagation();
                    const participantName = $(this).data('name');
                    if (confirm(`确定要移除参与者 "${participantName}" 吗？`)) {
                        if (isTimer) {
                            timerCurrentParticipantIndex = removeParticipant(
                                timerParticipants,
                                timerParticipantResults,
                                timerCurrentParticipantIndex,
                                participantName,
                                true
                            );
                            // 从当前局成绩中移除
                            delete timerCurrentSessionResults[participantName];
                            saveTimerData();
                            updateTimerParticipantsList();
                            updateTimerResultsTable();
                        } else {
                            stopwatchCurrentParticipantIndex = removeParticipant(
                                stopwatchParticipants,
                                stopwatchParticipantResults,
                                stopwatchCurrentParticipantIndex,
                                participantName,
                                false
                            );
                            // 从当前局成绩中移除
                            delete stopwatchCurrentSessionResults[participantName];
                            // 从多人同时计时记录中移除该参与者的关联
                            multiLapRecords.forEach(record => {
                                if (record.participant === participantName) {
                                record.participant = null;
                            }
                        });
                            saveStopwatchData();
                            updateStopwatchParticipantsList();
                            updateStopwatchResultsTable();
                            updateMultiLapTable();
                        }
                    }
                });

                $tag.on('click', function(e) {
                    if (!$(e.target).hasClass('remove-btn') &&
                        !$(e.target).parent().hasClass('remove-btn') &&
                        !$(e.target).hasClass('fa-grip-vertical') &&
                        !$(e.target).parent().hasClass('drag-handle')) {
                        if (isTimer) {
                            timerCurrentParticipantIndex = index;
                            updateTimerParticipantsList();
                        } else {
                            stopwatchCurrentParticipantIndex = index;
                            updateStopwatchParticipantsList();
                        }
                    }
                });

                $list.append($tag);
            });

                if ($list.sortable('instance')) {
                    $list.sortable('refresh');
                }
            } catch (error) {
                console.error("更新参与者列表失败:", error);
            }
        }

        // ==================== 成绩表格更新函数 ====================

        // 通用成绩表格更新函数 - 显示当前局成绩
        function updateResultsTable($body, $table, $emptyMsg, participants, results, currentIndex, sessionResults) {
            try {
                $body.empty();

                if (participants.length === 0) {
                    $emptyMsg.show();
                    $table.hide();
                    return;
                }

                $emptyMsg.hide();
                $table.show();

                // 计算当前局的名次（只考虑当前局的成绩）
                const participantsWithCurrentTimes = participants
                    .filter(name => {
                    return sessionResults[name] && sessionResults[name].length > 0;
            })
            .map(name => {
                    const times = sessionResults[name] || [];
                // 使用最好成绩作为排序依据
                const bestTime = times.length > 0 ? Math.min(...times) : Infinity;
                return {
                    name,
                    bestTime
                };
            })
            .sort((a, b) => a.bestTime - b.bestTime);

                const rankMap = {};
                participantsWithCurrentTimes.forEach((participant, index) => {
                    rankMap[participant.name] = index + 1;
            });

                // 添加成绩记录行
                participants.forEach((name, index) => {
                    if (!name) return;

                const participantResults = results[name] || {times: [], bestTime: null};
                const allTimes = participantResults.times || [];
                const bestTime = participantResults.bestTime;

                // 获取当前局成绩
                const currentTimes = sessionResults[name] || [];
                const currentTimesCount = currentTimes.length;

                const rank = rankMap[name] || '-';
                const rankClass = getRankClass(rank);

                const $row = $(`
                        <tr ${currentIndex === index ? 'class="current-player"' : ''}>
                            <td class="rank-cell ${rankClass}">${rank}</td>
                            <td class="player-name">${name}</td>
                            <td class="time-entry">${generateTimesHTML(currentTimes)}</td>
                            <td class="player-time best-time">${currentTimesCount > 0 ? formatTimeFromSeconds(Math.min(...currentTimes)) : '--:--:--'}</td>
                            <td class="player-time">${currentTimesCount}</td>
                        </tr>
                    `);

                $body.append($row);
            });
            } catch (error) {
                console.error("更新成绩表格失败:", error);
                $emptyMsg.show();
                $table.hide();
            }
        }

        // ==================== 倒计时模式函数 ====================

        function updateTimerFromInputs() {
            try {
                const hours = Math.max(0, parseInt($timerHours.val()) || 0);
                const minutes = Math.max(0, Math.min(59, parseInt($timerMinutes.val()) || 0));
                const seconds = Math.max(0, Math.min(59, parseInt($timerSeconds.val()) || 0));

                $timerHours.val(hours);
                $timerMinutes.val(minutes);
                $timerSeconds.val(seconds);

                timerTotalTime = hours * 3600 + minutes * 60 + seconds;
                timerTimeLeft = timerTotalTime;

                updateTimerDisplay();
            } catch (error) {
                console.error("更新时间输入失败:", error);
            }
        }

        function updateTimerDisplay() {
            try {
                if (timerTimeLeft < 0) timerTimeLeft = 0;

                const hours = Math.floor(timerTimeLeft / 3600);
                const minutes = Math.floor((timerTimeLeft % 3600) / 60);
                const seconds = timerTimeLeft % 60;

                const formattedHours = hours.toString().padStart(2, '0');
                const formattedMinutes = minutes.toString().padStart(2, '0');
                const formattedSeconds = seconds.toString().padStart(2, '0');

                $timerDisplay.text(`${formattedHours}:${formattedMinutes}:${formattedSeconds}`);

                if (timerTimeLeft <= 60 && timerTimeLeft > 0) {
                    $timerDisplay.css('color', '#ef4444');
                } else {
                    $timerDisplay.css('color', '#fbbf24');
                }
            } catch (error) {
                console.error("更新计时器显示失败:", error);
            }
        }

        function startTimer() {
            if (timerParticipants.length === 0) {
                alert('请先添加至少一名参与者！');
                return;
            }

            if (timerCurrentParticipantIndex === -1) {
                timerCurrentParticipantIndex = 0;
                updateTimerParticipantsList();
            }

            if (!timerRunning && timerTimeLeft > 0) {
                timerRunning = true;
                timerStartTime = Date.now();

                $timerStartBtn.html('<i class="fas fa-pause"></i><span>暂停计时</span>');
                $timerStartBtn.addClass('running');
                $timerStatusDot.addClass('active blink');
                $timerStatusText.text('计时中...');
                $timerDisplay.addClass('breathing');
                $timerSetter.find('input').prop('disabled', true);
                $timerParticipantInput.prop('disabled', true);
                $timerAddParticipantBtn.prop('disabled', true);

                clearInterval(timerInterval);
                timerInterval = setInterval(function() {
                    try {
                        const now = Date.now();
                        timerElapsedTime = now - timerStartTime;
                        const remaining = timerTotalTime * 1000 - timerElapsedTime;

                        timerTimeLeft = Math.max(0, Math.floor(remaining / 1000));
                        updateTimerDisplay();

                        if (timerTimeLeft <= 0) {
                            timerTimeLeft = 0;
                            pauseTimer();
                            recordTimerParticipantTime();

                            $timerDisplay.addClass('pulse');
                            setTimeout(() => {
                                $timerDisplay.removeClass('pulse');
                        }, 2000);

                            $timerDisplay.removeClass('breathing');
                            $timerStatusDot.removeClass('blink').addClass('active');
                            $timerStatusText.text('计时结束！');

                            setTimeout(() => {
                                nextTimerParticipant();
                        }, 2000);

                            setTimeout(() => {
                                $timerStatusDot.removeClass('active');
                            $timerStatusText.text('准备就绪');
                        }, 3000);
                        }
                    } catch (error) {
                        console.error("计时器更新错误:", error);
                        pauseTimer();
                    }
                }, 10);
            }
        }

        function pauseTimer() {
            if (timerRunning) {
                timerRunning = false;
                clearInterval(timerInterval);
                recordTimerParticipantTime();

                $timerStartBtn.html('<i class="fas fa-play"></i><span>继续计时</span>');
                $timerStartBtn.removeClass('running');
                $timerStatusDot.removeClass('blink active');
                $timerStatusText.text('已暂停');
                $timerDisplay.removeClass('breathing');
                $timerSetter.find('input').prop('disabled', false);
                $timerParticipantInput.prop('disabled', false);
                $timerAddParticipantBtn.prop('disabled', false);
            }
        }

        function recordTimerParticipantTime() {
            if (timerCurrentParticipantIndex >= 0 && timerCurrentParticipantIndex < timerParticipants.length) {
                const name = timerParticipants[timerCurrentParticipantIndex];
                const time = timerElapsedTime;

                if (time > 0) {
                    const timeInSeconds = time / 1000;

                    // 1. 实时保存到历史成绩
                    if (!timerParticipantResults[name]) {
                        timerParticipantResults[name] = {
                            times: [],
                            bestTime: null
                        };
                    }

                    timerParticipantResults[name].times.push(timeInSeconds);

                    if (timerParticipantResults[name].bestTime === null || timeInSeconds < timerParticipantResults[name].bestTime) {
                        timerParticipantResults[name].bestTime = timeInSeconds;
                    }

                    // 2. 保存到当前局成绩
                    if (!timerCurrentSessionResults[name]) {
                        timerCurrentSessionResults[name] = [];
                    }
                    timerCurrentSessionResults[name].push(timeInSeconds);

                    // 3. 更新成绩表格
                    updateTimerResultsTable();

                    // 4. 保存数据
                    saveTimerData();
                }
            }
        }

        function saveCurrentTimerSession() {
            // 保存当前局到历史记录
            const currentTime = new Date();

            // 计算当前局的名次和最好成绩
            const sessionResults = {};
            timerParticipants.forEach(name => {
                const currentTimes = timerCurrentSessionResults[name] || [];
            if (currentTimes.length > 0) {
                const bestTime = Math.min(...currentTimes);
                const rank = calculateRankInSession(name, timerCurrentSessionResults);
                sessionResults[name] = {
                    times: [...currentTimes],
                bestTime: bestTime,
                    rank: rank
            };
            }
        });

            const sessionRecord = {
                time: currentTime.toLocaleString('zh-CN'),
                timestamp: currentTime.getTime(),
                participants: timerParticipants,
                results: sessionResults,
                sessionNumber: timerAllSessions.length + 1
            };

            timerAllSessions.push(sessionRecord);
            saveTimerData();
        }

        function resetTimer() {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerRunning = false;
            }

            // 保存当前局成绩到历史记录
            if (Object.keys(timerCurrentSessionResults).length > 0) {
                saveCurrentTimerSession();
            }

            // 重置当前局成绩 - 清空当前局成绩
            timerCurrentSessionResults = {};

            updateTimerFromInputs();
            timerElapsedTime = 0;
            timerCurrentParticipantIndex = -1;
            updateTimerParticipantsList();

            $timerStartBtn.html('<i class="fas fa-play"></i><span>开始计时</span>');
            $timerStartBtn.removeClass('running');
            $timerStatusDot.removeClass('blink active');
            $timerStatusText.text('准备就绪');
            $timerDisplay.removeClass('breathing');
            $timerSetter.find('input').prop('disabled', false);
            $timerParticipantInput.prop('disabled', false);
            $timerAddParticipantBtn.prop('disabled', false);

            updateTimerDisplay();
            // 更新成绩表格 - 显示清空后的当前局成绩
            updateTimerResultsTable();
        }

        function nextTimerParticipant() {
            if (timerParticipants.length === 0) {
                alert('请先添加至少一名参与者！');
                return;
            }

            if (timerRunning) {
                pauseTimer();
            }

            timerCurrentParticipantIndex = (timerCurrentParticipantIndex + 1) % timerParticipants.length;
            updateTimerParticipantsList();

            timerElapsedTime = 0;
            timerTimeLeft = timerTotalTime;
            updateTimerDisplay();

            $nextParticipantBtn.addClass('pulse');
            setTimeout(() => {
                $nextParticipantBtn.removeClass('pulse');
        }, 500);
        }

        // ==================== 秒表模式函数 ====================

        function updateStopwatchDisplay() {
            try {
                const totalMilliseconds = stopwatchTime;
                const hours = Math.floor(totalMilliseconds / 3600000);
                const minutes = Math.floor((totalMilliseconds % 3600000) / 60000);
                const seconds = Math.floor((totalMilliseconds % 60000) / 1000);
                const milliseconds = Math.floor(totalMilliseconds % 1000);

                const formattedHours = hours.toString().padStart(2, '0');
                const formattedMinutes = minutes.toString().padStart(2, '0');
                const formattedSeconds = seconds.toString().padStart(2, '0');
                const formattedMilliseconds = milliseconds.toString().padStart(3, '0');

                $stopwatchDisplay.text(`${formattedHours}:${formattedMinutes}:${formattedSeconds}.${formattedMilliseconds}`);
            } catch (error) {
                console.error("更新秒表显示失败:", error);
            }
        }

        function startStopwatch() {
            if (stopwatchParticipants.length === 0) {
                alert('请先添加至少一名参与者！');
                return;
            }

            if (!stopwatchRunning) {
                stopwatchRunning = true;
                stopwatchStartTime = Date.now() - stopwatchTime;

                $stopwatchStartBtn.html('<i class="fas fa-pause"></i><span>暂停计时</span>');
                $stopwatchStartBtn.addClass('running');
                $stopwatchStatusDot.addClass('active blink');
                $stopwatchStatusText.text('计时中...');
                $stopwatchDisplay.addClass('breathing');
                $stopwatchParticipantInput.prop('disabled', true);
                $stopwatchAddParticipantBtn.prop('disabled', true);

                clearInterval(stopwatchInterval);
                stopwatchInterval = setInterval(function() {
                    try {
                        stopwatchTime = Date.now() - stopwatchStartTime;
                        updateStopwatchDisplay();
                    } catch (error) {
                        console.error("秒表更新错误:", error);
                        pauseStopwatch();
                    }
                }, 10);
            }
        }

        function pauseStopwatch() {
            if (stopwatchRunning) {
                stopwatchRunning = false;
                clearInterval(stopwatchInterval);

                $stopwatchStartBtn.html('<i class="fas fa-play"></i><span>继续计时</span>');
                $stopwatchStartBtn.removeClass('running');
                $stopwatchStatusDot.removeClass('blink');
                $stopwatchStatusText.text('已暂停');
                $stopwatchDisplay.removeClass('breathing');
                $stopwatchParticipantInput.prop('disabled', false);
                $stopwatchAddParticipantBtn.prop('disabled', false);
            }
        }

        function resetStopwatchTimer() {
            if (stopwatchRunning) {
                clearInterval(stopwatchInterval);
                stopwatchRunning = false;
            }

            stopwatchTime = 0;
            stopwatchStartTime = 0;

            $stopwatchStartBtn.html('<i class="fas fa-play"></i><span>开始计时</span>');
            $stopwatchStartBtn.removeClass('running');
            $stopwatchStatusDot.removeClass('blink active');
            $stopwatchStatusText.text('准备就绪');
            $stopwatchDisplay.removeClass('breathing');
            $stopwatchParticipantInput.prop('disabled', false);
            $stopwatchAddParticipantBtn.prop('disabled', false);

            updateStopwatchDisplay();
        }

        function recordStopwatchTime() {
            if (stopwatchCurrentParticipantIndex >= 0 && stopwatchCurrentParticipantIndex < stopwatchParticipants.length) {
                const name = stopwatchParticipants[stopwatchCurrentParticipantIndex];
                const time = stopwatchTime;

                if (time > 0) {
                    const timeInSeconds = time / 1000;

                    // 1. 实时保存到历史成绩
                    if (!stopwatchParticipantResults[name]) {
                        stopwatchParticipantResults[name] = {
                            times: [],
                            bestTime: null
                        };
                    }

                    stopwatchParticipantResults[name].times.push(timeInSeconds);

                    if (stopwatchParticipantResults[name].bestTime === null || timeInSeconds < stopwatchParticipantResults[name].bestTime) {
                        stopwatchParticipantResults[name].bestTime = timeInSeconds;
                    }

                    // 2. 保存到当前局成绩
                    if (!stopwatchCurrentSessionResults[name]) {
                        stopwatchCurrentSessionResults[name] = [];
                    }
                    stopwatchCurrentSessionResults[name].push(timeInSeconds);

                    // 3. 更新成绩表格
                    updateStopwatchResultsTable();

                    // 4. 保存数据
                    saveStopwatchData();

                    $recordTimeBtn.addClass('pulse');
                    setTimeout(() => {
                        $recordTimeBtn.removeClass('pulse');
                    }, 500);

                    // ==================== 新增：自动切换到下一个人 ====================
                    // 暂停计时器
                    if (stopwatchRunning) {
                        pauseStopwatch();
                    }

                    // 重置秒表时间
                    stopwatchTime = 0;
                    updateStopwatchDisplay();

                    // 切换到下一个参与者
                    if (stopwatchParticipants.length > 0) {
                        stopwatchCurrentParticipantIndex = (stopwatchCurrentParticipantIndex + 1) % stopwatchParticipants.length;
                        updateStopwatchParticipantsList();

                        // 显示提示信息
                        const nextName = stopwatchParticipants[stopwatchCurrentParticipantIndex];
                        $stopwatchStatusText.text(`已记录 ${name} 的成绩，当前选手：${nextName}`);

                        setTimeout(() => {
                            $stopwatchStatusText.text('准备就绪');
                        }, 2000);
                    }
                    // ==================== 新增结束 ====================

                } else {
                    alert('请先开始计时！');
                }
            } else {
                alert('请先选择参与者！');
            }
        }

        function saveCurrentStopwatchSession() {
            // 保存当前局到历史记录
            const currentTime = new Date();

            // 计算当前局的名次和最好成绩
            const sessionResults = {};
            stopwatchParticipants.forEach(name => {
                const currentTimes = stopwatchCurrentSessionResults[name] || [];
            if (currentTimes.length > 0) {
                const bestTime = Math.min(...currentTimes);
                const rank = calculateRankInSession(name, stopwatchCurrentSessionResults);
                sessionResults[name] = {
                    times: [...currentTimes],
                bestTime: bestTime,
                    rank: rank
                };
                }
            });

            const sessionRecord = {
                time: currentTime.toLocaleString('zh-CN'),
                timestamp: currentTime.getTime(),
                participants: stopwatchParticipants,
                results: sessionResults,
                sessionNumber: stopwatchAllSessions.length + 1
            };

            stopwatchAllSessions.push(sessionRecord);
            saveStopwatchData();
        }

        function resetStopwatch() {
            resetStopwatchTimer();

            // 保存当前轮次成绩到历史记录
            if (Object.keys(stopwatchCurrentSessionResults).length > 0) {
                saveCurrentStopwatchSession();
            }

            // 重置当前局成绩 - 清空当前局成绩
            stopwatchCurrentSessionResults = {};

            multiLapRecords = [];
            updateMultiLapTable();

            // 更新成绩表格 - 显示清空后的当前局成绩
            updateStopwatchResultsTable();
        }

        // ==================== 多人同时计时函数 ====================

        function recordMultiLap() {
            if (stopwatchTime > 0) {
                const rank = multiLapRecords.length + 1;

                multiLapRecords.push({
                    rank: rank,
                    time: stopwatchTime,
                    participant: null
                });

                updateMultiLapTable();

                $stopwatchLapBtn.addClass('pulse');
                setTimeout(() => {
                    $stopwatchLapBtn.removeClass('pulse');
            }, 500);
            } else {
                alert('请先开始计时！');
            }
        }

        function updateMultiLapTable() {
            try {
                $multiLapBody.empty();

                if (multiLapRecords.length === 0) {
                    $multiLapEmptyMessage.show();
                    $multiLapTable.hide();
                    return;
                }

                $multiLapEmptyMessage.hide();
                $multiLapTable.show();

                let participantOptions = '<option value="">选择参与者</option>';
                stopwatchParticipants.forEach(name => {
                    if (name && typeof name === 'string') {
                    participantOptions += `<option value="${name}">${name}</option>`;
                }
            });

                multiLapRecords.forEach((record, index) => {
                    const rankClass = getLapRankClass(record.rank);

                const $row = $(`
                        <tr>
                            <td class="lap-rank ${rankClass}">${record.rank}</td>
                            <td class="lap-time">${formatTimeFromMilliseconds(record.time)}</td>
                            <td>
                                <select class="participant-select" data-index="${index}">
                                    ${participantOptions}
                                </select>
                            </td>
                            <td>
                                <button class="delete-lap-btn" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                    <span>删除</span>
                                </button>
                            </td>
                        </tr>
                    `);

                if (record.participant) {
                    $row.find('.participant-select').val(record.participant);
                }

                $row.find('.participant-select').on('change', function() {
                    const idx = $(this).data('index');
                    const selectedParticipant = $(this).val();
                    multiLapRecords[idx].participant = selectedParticipant || null;
                });

                $row.find('.delete-lap-btn').on('click', function() {
                    const idx = $(this).data('index');
                    deleteMultiLapRecord(idx);
                });

                $multiLapBody.append($row);
            });
            } catch (error) {
                console.error("更新多人计时表格失败:", error);
                $multiLapEmptyMessage.show();
                $multiLapTable.hide();
            }
        }

        function saveAllMultiLapRecords() {
            const unassignedRecords = multiLapRecords.filter(record => !record.participant);
            if (unassignedRecords.length > 0) {
                alert(`还有${unassignedRecords.length}个名次未分配参与者！`);
                return;
            }

            if (multiLapRecords.length === 0) {
                alert('没有可保存的成绩记录！');
                return;
            }

            let hasInvalidParticipant = false;
            multiLapRecords.forEach(record => {
                if (!stopwatchParticipants.includes(record.participant)) {
                alert(`参与者"${record.participant}"不存在！`);
                hasInvalidParticipant = true;
            }
        });

            if (hasInvalidParticipant) {
                return;
            }

            // 保存多人同时计时成绩到当前局
            multiLapRecords.forEach(record => {
                const name = record.participant;
            const timeInSeconds = record.time / 1000;

            // 保存到当前局成绩
            if (!stopwatchCurrentSessionResults[name]) {
                stopwatchCurrentSessionResults[name] = [];
            }
            stopwatchCurrentSessionResults[name].push(timeInSeconds);
        });

            // 更新成绩表格
            updateStopwatchResultsTable();

            // 清空多人计时记录
            multiLapRecords = [];
            updateMultiLapTable();
            resetStopwatchTimer();

            alert('成功保存所有成绩！计时器已复位，可以开始下一轮计时。');
        }

        function deleteMultiLapRecord(index) {
            if (confirm('确定要删除这条记录吗？')) {
                multiLapRecords.splice(index, 1);

                multiLapRecords.forEach((rec, idx) => {
                    rec.rank = idx + 1;
            });

                updateMultiLapTable();
            }
        }

        function clearMultiLapRecords() {
            if (multiLapRecords.length === 0) {
                return;
            }

            if (confirm('确定要清空所有名次记录吗？')) {
                multiLapRecords = [];
                updateMultiLapTable();
            }
        }

        // ==================== 历史记录函数 ====================

        function showTimerHistory() {
            showHistoryModal('timer');
        }

        function showStopwatchHistory() {
            showHistoryModal('stopwatch');
        }

        function showHistoryModal(defaultTab = 'timer') {
            loadHistoryData();
            $historyModal.addClass('active');
            switchHistoryTab(defaultTab + '-history');
        }

        function hideHistoryModal() {
            $historyModal.removeClass('active');
        }

        function switchHistoryTab(tabId) {
            $historyTabs.find('.history-tab').removeClass('active');
            $historyTabs.find(`.history-tab[data-tab="${tabId}"]`).addClass('active');

            $('.history-tab-content').removeClass('active');
            $(`#${tabId}-content`).addClass('active');
        }

        function loadHistoryData() {
            updateTimerHistoryTable();
            updateStopwatchHistoryTable();
        }

        function updateTimerHistoryTable() {
            try {
                $timerHistoryBody.empty();

                if (timerAllSessions.length === 0) {
                    $timerHistoryEmpty.show();
                    return;
                }

                $timerHistoryEmpty.hide();

                // 按时间倒序排列，每个局作为一行
                const sortedSessions = [...timerAllSessions].sort((a, b) => b.timestamp - a.timestamp);

                sortedSessions.forEach((session, sessionIndex) => {
                    if (!session.results || Object.keys(session.results).length === 0) return;

                // 获取当前局的所有参与者成绩
                const sessionParticipants = Object.keys(session.results);
                const rankedParticipants = sessionParticipants
                    .filter(name => session.results[name].rank)
            .sort((a, b) => session.results[a].rank - session.results[b].rank);

                // 显示每个参与者的成绩
                rankedParticipants.forEach(name => {
                    const participantData = session.results[name];
                if (participantData.times.length > 0) {
                    const bestTime = participantData.bestTime;
                    const rank = participantData.rank;
                    const rankClass = getRankClass(rank);
                    const timesHTML = generateHistoryTimesHTML(participantData.times);

                    const $row = $(`
                                <tr>
                                    <td class="rank-cell" width="10%">${session.sessionNumber || (timerAllSessions.length - sessionIndex)}</td>
                                    <td class="session-time" width="15%">${session.time}</td>
                                    <td class="rank-cell ${rankClass}" width="10%">${rank}</td>
                                    <td class="player-name" width="20%">${name}</td>
                                    <td class="time-entry" width="25%">${timesHTML}</td>
                                    <td class="player-time best-time" width="20%">
                                        ${formatTimeFromSeconds(bestTime)}
                                    </td>
                                </tr>
                            `);
                    $timerHistoryBody.append($row);
                }
            });
            });
            } catch (error) {
                console.error("更新倒计时历史表格失败:", error);
                $timerHistoryEmpty.show();
            }
        }

        function updateStopwatchHistoryTable() {
            try {
                $stopwatchHistoryBody.empty();

                if (stopwatchAllSessions.length === 0) {
                    $stopwatchHistoryEmpty.show();
                    return;
                }

                $stopwatchHistoryEmpty.hide();

                // 按时间倒序排列，每个局作为一行
                const sortedSessions = [...stopwatchAllSessions].sort((a, b) => b.timestamp - a.timestamp);

                sortedSessions.forEach((session, sessionIndex) => {
                    if (!session.results || Object.keys(session.results).length === 0) return;

                // 获取当前局的所有参与者成绩
                const sessionParticipants = Object.keys(session.results);
                const rankedParticipants = sessionParticipants
                    .filter(name => session.results[name].rank)
            .sort((a, b) => session.results[a].rank - session.results[b].rank);

                // 显示每个参与者的成绩
                rankedParticipants.forEach(name => {
                    const participantData = session.results[name];
                if (participantData.times.length > 0) {
                    const bestTime = participantData.bestTime;
                    const rank = participantData.rank;
                    const rankClass = getRankClass(rank);
                    const timesHTML = generateHistoryTimesHTML(participantData.times);

                    const $row = $(`
                                <tr>
                                    <td class="rank-cell" width="10%">${session.sessionNumber || (stopwatchAllSessions.length - sessionIndex)}</td>
                                    <td class="session-time" width="15%">${session.time}</td>
                                    <td class="rank-cell ${rankClass}" width="10%">${rank}</td>
                                    <td class="player-name" width="20%">${name}</td>
                                    <td class="time-entry" width="25%">${timesHTML}</td>
                                    <td class="player-time best-time" width="20%">
                                        ${formatTimeFromSeconds(bestTime)}
                                    </td>
                                </tr>
                            `);
                    $stopwatchHistoryBody.append($row);
                }
            });
            });
            } catch (error) {
                console.error("更新秒表历史表格失败:", error);
                $stopwatchHistoryEmpty.show();
            }
        }

        // ==================== UI更新函数 ====================

        function updateTimerParticipantsList() {
            updateParticipantsList($timerParticipantsList, timerParticipants, timerCurrentParticipantIndex, true);
        }

        function updateStopwatchParticipantsList() {
            updateParticipantsList($stopwatchParticipantsList, stopwatchParticipants, stopwatchCurrentParticipantIndex, false);
        }

        function updateTimerResultsTable() {
            // 显示当前局成绩（重置后会清空）
            updateResultsTable($timerResultsBody, $timerResultsTable, $timerEmptyResultsMessage,
                timerParticipants, timerParticipantResults, timerCurrentParticipantIndex, timerCurrentSessionResults);
        }

        function updateStopwatchResultsTable() {
            // 显示当前局成绩（重置后会清空）
            updateResultsTable($stopwatchResultsBody, $stopwatchResultsTable, $stopwatchEmptyResultsMessage,
                stopwatchParticipants, stopwatchParticipantResults, stopwatchCurrentParticipantIndex, stopwatchCurrentSessionResults);
        }

        function updateClock() {
            try {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                $currentTimeDisplay.text(`${hours}:${minutes}:${seconds}`);
            } catch (error) {
                console.error("更新时钟失败:", error);
            }
        }

        // ==================== 事件处理函数 ====================

        function toggleFullscreenMode() {
            if (!isFullscreen) {
                const element = document.documentElement;
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestfullscreen();
                }

                $fullscreenToggle.addClass('active').html('<i class="fas fa-compress"></i><span>退出全屏</span>');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                $fullscreenToggle.removeClass('active').html('<i class="fas fa-expand"></i><span>全屏模式</span>');
            }
        }

        function handleFullscreenChange() {
            const fullscreenElement =
                document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;

            isFullscreen = !!fullscreenElement;

            if (isFullscreen) {
                $mainContainer.addClass('fullscreen-mode');
                $fullscreenToggle.addClass('active').html('<i class="fas fa-compress"></i><span>退出全屏</span>');
            } else {
                $mainContainer.removeClass('fullscreen-mode');
                $fullscreenToggle.removeClass('active').html('<i class="fas fa-expand"></i><span>全屏模式</span>');
            }
        }

        function switchToTimerMode() {
            currentMode = 'timer';
            $timerModeBtn.addClass('active');
            $stopwatchModeBtn.removeClass('active');
            $timerPanel.removeClass('hidden');
            $stopwatchPanel.addClass('hidden');
            updateTimerDisplay();
        }

        function switchToStopwatchMode() {
            currentMode = 'stopwatch';
            $stopwatchModeBtn.addClass('active');
            $timerModeBtn.removeClass('active');
            $stopwatchPanel.removeClass('hidden');
            $timerPanel.addClass('hidden');
            updateStopwatchDisplay();
        }

        function toggleTimer() {
            if (timerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function toggleStopwatch() {
            if (stopwatchRunning) {
                pauseStopwatch();
            } else {
                startStopwatch();
            }
        }

        function addTimerParticipantFromInput() {
            const name = $timerParticipantInput.val().trim();
            if (name) {
                if (addParticipant(timerParticipants, timerParticipantResults, name, true)) {
                    $timerParticipantInput.val('');
                    $timerParticipantInput.focus();

                    if (timerParticipants.length === 1) {
                        timerCurrentParticipantIndex = 0;
                        updateTimerParticipantsList();
                    } else {
                        updateTimerParticipantsList();
                    }

                    saveTimerData();
                    updateTimerResultsTable();
                }
            }
        }

        function addStopwatchParticipantFromInput() {
            const name = $stopwatchParticipantInput.val().trim();
            if (name) {
                // 修复：使用统一的参与者检查逻辑
                if (!name || name.trim() === '') {
                    alert('参与者姓名不能为空！');
                    return;
                }

                if (stopwatchParticipants.includes(name)) {
                    alert('该参与者已存在！');
                    return;
                }

                // 添加到参与者列表
                stopwatchParticipants.push(name);

                // 初始化成绩记录
                if (!stopwatchParticipantResults[name]) {
                    stopwatchParticipantResults[name] = {
                        times: [],
                        bestTime: null
                    };
                }

                // 清空输入框
                $stopwatchParticipantInput.val('');
                $stopwatchParticipantInput.focus();

                // 更新UI
                updateStopwatchParticipantsList();

                // 保存数据
                saveStopwatchData();

                // 更新成绩表格
                updateStopwatchResultsTable();

                // 更新多人计时表格
                updateMultiLapTable();
            }
        }

        // ==================== 初始化函数 ====================

        function initDragAndDrop() {
            console.log("初始化拖拽功能...");

            // 检查jQuery UI sortable是否可用
            if ($.ui && $.ui.sortable) {
                console.log("jQuery UI sortable可用，正在初始化拖拽...");

                // 倒计时参与者列表拖拽
                $timerParticipantsList.sortable({
                    items: '.participant-tag',
                    placeholder: 'ui-sortable-placeholder',
                    cursor: 'move',
                    opacity: 0.7,
                    tolerance: 'pointer',
                    delay: 150,
                    containment: 'parent',
                    start: function(event, ui) {
                        ui.item.addClass('dragging');
                        $(this).addClass('sorting-active');
                        // 修复：设置占位符高度
                        ui.placeholder.css({
                            'height': ui.helper.outerHeight(),
                            'width': ui.helper.outerWidth()
                        });
                    },
                    stop: function(event, ui) {
                        ui.item.removeClass('dragging');
                        $(this).removeClass('sorting-active');
                        updateTimerParticipantsOrder();
                    },
                    update: function(event, ui) {
                        updateTimerParticipantsOrder();
                    }
                });

                // 秒表参与者列表拖拽
                $stopwatchParticipantsList.sortable({
                    items: '.participant-tag',
                    placeholder: 'ui-sortable-placeholder',
                    cursor: 'move',
                    opacity: 0.7,
                    tolerance: 'pointer',
                    delay: 150,
                    //containment: 'parent',
                    start: function(event, ui) {
                        ui.item.addClass('dragging');
                        $(this).addClass('sorting-active');
                        // 修复：设置占位符高度
                        ui.placeholder.css({
                            'height': ui.helper.outerHeight(),
                            'width': ui.helper.outerWidth()
                        });
                    },
                    stop: function(event, ui) {
                        ui.item.removeClass('dragging');
                        $(this).removeClass('sorting-active');
                        updateStopwatchParticipantsOrder();
                    },
                    update: function(event, ui) {
                        updateStopwatchParticipantsOrder();
                    }
                });

                console.log("拖拽功能初始化完成");
            } else {
                console.warn("jQuery UI sortable不可用，拖拽功能禁用");
                console.log("jQuery UI版本:", $.ui ? $.ui.version : "未加载");

                // 显示提示信息
                const style = 'color: #fbbf24; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 4px;';
                console.log('%c注意：拖拽功能需要jQuery UI支持，请确保已正确加载jQuery UI库', style);
            }
        }

        function updateTimerParticipantsOrder() {
            const newOrder = [];
            $timerParticipantsList.find('.participant-tag').each(function() {
                const name = $(this).find('span:first').text();
                if (name && name.trim() !== '') {
                    newOrder.push(name);
                }
            });

            timerParticipants = newOrder;
            saveTimerData();
            updateTimerResultsTable();
        }

        function updateStopwatchParticipantsOrder() {
            const newOrder = [];
            $stopwatchParticipantsList.find('.participant-tag').each(function() {
                const name = $(this).find('span:first').text();
                if (name && name.trim() !== '') {
                    newOrder.push(name);
                }
            });

            stopwatchParticipants = newOrder;
            saveStopwatchData();
            updateStopwatchResultsTable();
            updateMultiLapTable();
        }

        function bindEvents() {
            console.log("绑定事件...");

            $fullscreenToggle.on('click', toggleFullscreenMode);
            $timerModeBtn.on('click', switchToTimerMode);
            $stopwatchModeBtn.on('click', switchToStopwatchMode);

            $timerStartBtn.on('click', toggleTimer);
            $timerResetBtn.on('click', resetTimer);
            $nextParticipantBtn.on('click', nextTimerParticipant);
            $timerHistoryBtn.on('click', showTimerHistory);

            $timerHours.on('change', updateTimerFromInputs);
            $timerMinutes.on('change', updateTimerFromInputs);
            $timerSeconds.on('change', updateTimerFromInputs);

            $timerAddParticipantBtn.on('click', addTimerParticipantFromInput);
            $timerParticipantInput.on('keypress', function(e) {
                if (e.which === 13) addTimerParticipantFromInput();
            });

            $stopwatchStartBtn.on('click', toggleStopwatch);
            $recordTimeBtn.on('click', recordStopwatchTime);
            $stopwatchLapBtn.on('click', recordMultiLap);
            $stopwatchResetBtn.on('click', resetStopwatch);
            $stopwatchHistoryBtn.on('click', showStopwatchHistory);

            $stopwatchAddParticipantBtn.on('click', addStopwatchParticipantFromInput);
            $stopwatchParticipantInput.on('keypress', function(e) {
                if (e.which === 13) addStopwatchParticipantFromInput();
            });

            $clearMultiLapBtn.on('click', clearMultiLapRecords);
            $saveAllLapsBtn.on('click', saveAllMultiLapRecords);

            $historyModalClose.on('click', hideHistoryModal);
            $historyModal.on('click', function(e) {
                if (e.target === this) hideHistoryModal();
            });

            $historyTabs.on('click', '.history-tab', function() {
                const tab = $(this).data('tab');
                switchHistoryTab(tab);
            });

            $(document).on('fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange', handleFullscreenChange);

            console.log("事件绑定完成");
        }

        function init() {
            console.log("初始化开始...");
            try {
                updateClock();
                setInterval(updateClock, 1000);

                try {
                    loadFromStorage();
                    console.log("加载参与者后，倒计时参与者:", timerParticipants);
                    console.log("加载参与者后，秒表参与者:", stopwatchParticipants);
                } catch (storageError) {
                    console.warn("从localStorage加载数据失败，使用默认数据:", storageError);
                    resetAllData();
                }

                // 初始化当前局成绩
                timerCurrentSessionResults = {};
                stopwatchCurrentSessionResults = {};

                // 更新参与者列表 - 确保从localStorage加载的参与者在页面显示
                updateTimerParticipantsList();
                updateStopwatchParticipantsList();

                resetTimer();
                resetStopwatch();
                updateMultiLapTable();

                try {
                    initDragAndDrop();
                } catch (dragError) {
                    console.warn("拖拽初始化失败:", dragError);
                }

                bindEvents();
                switchToTimerMode();
                updateTimerResultsTable();
                updateStopwatchResultsTable();

                console.log('系统初始化完成');
            } catch (error) {
                console.error('初始化过程中发生错误:', error);
                emergencyReset();
            }
        }

        // 初始化应用
        init();
    });
</script>
</body>
</html>