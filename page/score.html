<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>比分记录</title>
    <link rel="stylesheet" href="../css/all.min.css">
    <script src="../js/chart.js"></script>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script-- src="https://code.jquery.com/jquery-3.6.0.min.js"></script-->
    <link rel="stylesheet" href="../css/base.css">
    <script src="../js/base.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a, #1a1a1a, #2a2a2a);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: all 0.5s ease;
        }

        /* 返回主页按钮 */
        .back-to-home {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, #4a5568, #2d3748);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-to-home:hover {
            background: linear-gradient(145deg, #5a6578, #3d4858);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* 当前时间显示 */
        .current-time {
            position: fixed;
            top: 20px;
            right: 40px;
            background: linear-gradient(145deg, #222222, #111111);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffcc00;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 2px solid #444444;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        #current-time-display{
            font-family: 'Courier New', monospace;
        }

        /* 全屏按钮 */
        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .fullscreen-toggle {
            background: linear-gradient(to right, #d69e2e, #b7791f);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .fullscreen-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .fullscreen-toggle.active {
            background: linear-gradient(to right, #b7791f, #975a16);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* 精简模式样式 */
        .compact-mode {
            max-width: 900px;
        }

        .compact-mode .chart-panel,
        .compact-mode .team-stats,
        .compact-mode .foul-controls,
        .compact-mode .compact-item {
            display: none !important;
        }

        .compact-mode .score-controls .score-btn {
            min-width: 70px;
            padding: 10px 4px;
            font-size: 0.9rem;
        }

        .compact-mode .score-controls .score-btn i {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .compact-mode .team-scoreboard {
            padding: 15px;
            *max-width: 350px;
        }

        .compact-mode .score {
            font-size: 4.5rem;
            min-height: 100px;
            padding: 12px;
        }

        .compact-mode .control-panel {
            padding: 15px;
        }

        .compact-mode .global-btn {
            min-width: 150px;
            padding: 12px 15px;
        }

        /* 横屏模式样式 - 改为旋转方式 */
        .landscape-mode {
            transform: rotate(90deg);
            transform-origin: center center;
            width: 100vh;
            height: 100vw;
            max-width: none;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-top: -50vw;
            margin-left: -50vh;
            overflow: auto;
            padding: 20px;
        }

        .landscape-mode .main-content {
            flex-direction: row;
            height: 100%;
        }

        .landscape-mode .left-panel,
        .landscape-mode .right-panel {
            height: 100%;
            overflow-y: auto;
        }

        .landscape-mode .scoreboard-container {
            flex-direction: row;
        }

        .landscape-mode .team-scoreboard {
            max-width: none;
            height: 100%;
        }

        .landscape-mode .timer-panel {
            margin-bottom: 20px;
        }

        .landscape-mode .chart-panel {
            margin-bottom: 20px;
        }

        /* 控制面板标题固定样式 */
        .control-panel-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(145deg, #222222, #111111);
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 2px solid #444444;
        }

        .control-panel-content {
            overflow-y: auto;
            max-height: 500px;
        }

        .landscape-mode .control-panel-content {
            max-height: 70vh;
        }

        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .mode-toggle {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            padding: 12px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .mode-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .mode-toggle i {
            font-size: 1.2rem;
        }

        .compact-toggle {
            background: linear-gradient(to right, #805ad5, #6b46c1);
        }

        .landscape-toggle {
            background: linear-gradient(to right, #38a169, #2f855a);
        }

        .compact-toggle.active {
            background: linear-gradient(to right, #6b46c1, #553c9a);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .landscape-toggle.active {
            background: linear-gradient(to right, #2f855a, #276749);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        header {
            text-align: center;
            margin-bottom: 6px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            letter-spacing: 2px;
            font-weight: 800;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #cccccc;
            margin-bottom: 20px;
        }

        .main-content {
            *display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }

        .left-panel {
            flex: 3;
            min-width: 300px;
        }

        .right-panel {
            flex: 2;
            min-width: 300px;
        }

        .scoreboard-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .team-scoreboard {
            background: linear-gradient(145deg, #222222, #111111);
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            width: calc(50% - 20px);
            box-shadow:
                    0 5px 15px rgba(0, 0, 0, 0.6),
                    inset 0 0 20px rgba(0, 0, 0, 0.8);
            border: 4px solid #333333;
            position: relative;
            overflow: hidden;
        }

        /* 比分牌金属边框效果 */
        .team-scoreboard::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #555555, #888888, #555555);
            z-index: -1;
            border-radius: 10px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #444444;
        }

        .team-title {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .team1 .team-title {
            color: #ff3333;
            text-shadow: 0 0 5px rgba(255, 51, 51, 0.7);
        }

        .team2 .team-title {
            color: #3366ff;
            text-shadow: 0 0 5px rgba(51, 102, 255, 0.7);
        }

        .score {
            font-size: 5.5rem;
            font-weight: 900;
            text-align: center;
            margin: 12px 0;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            background: linear-gradient(145deg, #000000, #1a1a1a);
            border-radius: 10px;
            padding: 15px;
            min-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #444444;
            font-family: 'Courier New', monospace;
            box-shadow:
                    inset 0 0 15px rgba(0, 0, 0, 0.9),
                    0 5px 10px rgba(0, 0, 0, 0.5);
            color: #ffff00;
            letter-spacing: 2px;
        }

        .team1 .score {
            border-color: #ff3333;
            box-shadow:
                    inset 0 0 15px rgba(0, 0, 0, 0.9),
                    0 5px 10px rgba(0, 0, 0, 0.5),
                    0 0 10px rgba(255, 51, 51, 0.3);
        }

        .team2 .score {
            border-color: #3366ff;
            box-shadow:
                    inset 0 0 15px rgba(0, 0, 0, 0.9),
                    0 5px 10px rgba(0, 0, 0, 0.5),
                    0 0 10px rgba(51, 102, 255, 0.3);
        }

        .team-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border: 2px solid #333333;
        }

        .stat-item {
            text-align: center;
            padding: 0 10px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #aaaaaa;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .team1 .stat-value {
            color: #ff6666;
        }

        .team2 .stat-value {
            color: #6699ff;
        }

        .foul-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .foul-btn {
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .add-foul-btn {
            background: linear-gradient(to bottom, #555555, #222222);
            color: #ffffff;
            border: 1px solid #666666;
        }

        .add-foul-btn:hover {
            background: linear-gradient(to bottom, #666666, #333333);
            transform: scale(1.05);
        }

        .remove-foul-btn {
            background: linear-gradient(to bottom, #333333, #111111);
            color: #cccccc;
            border: 1px solid #444444;
        }

        .remove-foul-btn:hover {
            background: linear-gradient(to bottom, #444444, #222222);
            transform: scale(1.05);
        }

        .score-controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .score-btn {
            flex: 1;
            min-width: 70px;
            padding: 12px 5px;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        .score-btn i {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .add-btn {
            background: linear-gradient(to bottom, #44aa44, #226622);
            border: 1px solid #55bb55;
        }

        .add-btn:hover {
            background: linear-gradient(to bottom, #55bb55, #337733);
            transform: scale(1.05);
        }

        .subtract-btn {
            background: linear-gradient(to bottom, #aa4444, #662222);
            border: 1px solid #bb5555;
        }

        .subtract-btn:hover {
            background: linear-gradient(to bottom, #bb5555, #773333);
            transform: scale(1.05);
        }

        .reset-btn {
            background: linear-gradient(to bottom, #777744, #555522);
            border: 1px solid #888855;
        }

        .reset-btn:hover {
            background: linear-gradient(to bottom, #888855, #666633);
            transform: scale(1.05);
        }

        .control-panel {
            background: linear-gradient(145deg, #222222, #111111);
            border-radius: 8px;
            padding: 20px;
            box-shadow:
                    0 5px 15px rgba(0, 0, 0, 0.6),
                    inset 0 0 20px rgba(0, 0, 0, 0.8);
            border: 4px solid #333333;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #555555, #888888, #555555);
            z-index: -1;
            border-radius: 10px;
        }

        .control-panel h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #ffcc00;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }

        .mode-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border: 2px solid #333333;
        }

        .mode-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .mode-label {
            font-weight: 600;
            color: #cccccc;
            letter-spacing: 1px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 55px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333333;
            transition: .4s;
            border-radius: 34px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.8);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #44aa44;
        }

        input:checked + .slider:before {
            transform: translateX(29px);
        }

        .match-period {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border: 2px solid #333333;
            margin-bottom: 15px;
        }

        .period-label {
            font-weight: 600;
            color: #cccccc;
            letter-spacing: 1px;
        }

        .period-controls {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            padding: 8px 15px;
            background: #333333;
            border: none;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
            letter-spacing: 1px;
        }

        .period-btn:hover {
            background: #444444;
        }

        .period-btn.active {
            background: #ffcc00;
            color: #000000;
        }

        .match-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .match-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border: 2px solid #333333;
        }

        .match-info-item label {
            font-weight: 600;
            color: #cccccc;
            letter-spacing: 1px;
        }

        .match-info-item input, .match-info-item select {
            background: #333333;
            border: 1px solid #555555;
            border-radius: 4px;
            padding: 8px 12px;
            color: #ffffff;
            width: 180px;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
        }

        .global-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .global-btn {
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 170px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        .reset-all-btn {
            background: linear-gradient(to bottom, #777744, #555522);
            color: white;
            border: 1px solid #888855;
        }

        .reset-all-btn:hover {
            background: linear-gradient(to bottom, #888855, #666633);
            transform: translateY(-2px);
        }

        .history-btn {
            background: linear-gradient(to bottom, #555577, #333355);
            color: white;
            border: 1px solid #666688;
        }

        .history-btn:hover {
            background: linear-gradient(to bottom, #666688, #444466);
            transform: translateY(-2px);
        }

        .export-btn {
            background: linear-gradient(to bottom, #447777, #225555);
            color: white;
            border: 1px solid #558888;
        }

        .export-btn:hover {
            background: linear-gradient(to bottom, #558888, #336666);
            transform: translateY(-2px);
        }

        .chart-panel {
            background: linear-gradient(145deg, #222222, #111111);
            border-radius: 8px;
            padding: 20px;
            box-shadow:
                    0 5px 15px rgba(0, 0, 0, 0.6),
                    inset 0 0 20px rgba(0, 0, 0, 0.8);
            border: 4px solid #333333;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .chart-panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #555555, #888888, #555555);
            z-index: -1;
            border-radius: 10px;
        }

        .chart-panel h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #ffcc00;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .score-history {
            background: linear-gradient(145deg, #222222, #111111);
            border-radius: 8px;
            padding: 20px;
            box-shadow:
                    0 5px 15px rgba(0, 0, 0, 0.6),
                    inset 0 0 20px rgba(0, 0, 0, 0.8);
            border: 4px solid #333333;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .score-history::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #555555, #888888, #555555);
            z-index: -1;
            border-radius: 10px;
        }

        .score-history h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #ffcc00;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background-color: #333333;
            padding: 12px;
            text-align: left;
            color: #ffcc00;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .history-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #333333;
            font-family: 'Courier New', monospace;
        }

        .history-table tr:hover {
            background-color: rgba(255, 204, 0, 0.1);
        }

        .empty-history {
            text-align: center;
            padding: 25px;
            color: #888888;
            font-style: italic;
        }

        .clear-history-btn {
            background: linear-gradient(to bottom, #aa4444, #662222);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            display: block;
            margin-left: auto;
            margin-right: auto;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .clear-history-btn:hover {
            background: linear-gradient(to bottom, #bb5555, #773333);
            transform: translateY(-2px);
        }

        footer {
            margin-top: 20px;
            text-align: center;
            color: #888888;
            font-size: 0.85rem;
            padding: 15px;
            border-top: 2px solid #333333;
        }

        /* 全屏模式样式 */
        .fullscreen-mode {
            width: 100vw;
            height: 100vh;
            max-width: none;
            padding: 10px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
            background: #0a0a0a;
            overflow: auto;
        }

        .fullscreen-mode .current-time {
            font-size: 2rem;
            padding: 15px 30px;
        }

        .fullscreen-mode .score {
            font-size: 8rem;
            min-height: 200px;
        }

        .fullscreen-mode .score-btn {
            font-size: 1.2rem;
            padding: 15px 5px;
        }

        .logo {
            font-size: 1.8rem;
            color: #ffcc00;
            margin-bottom: 10px;
        }

        .hidden{
            display: none;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
        }

        /* 自动保存提示 */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(145deg, #225522, #113311);
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 0.8rem;
            color: #aaffaa;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>

<!-- 返回主页按钮 -->
<a href="javascript:history.back();" class="back-to-home">
    <i class="fas fa-home"></i>
    <span class="hidden">返回主页</span>
</a>

<!-- 自动保存提示 -->
<div class="auto-save-indicator" id="auto-save-indicator">
    <i class="fas fa-save"></i>
    <span>数据已保存</span>
</div>

<div class="container" id="main-container">
    <header>
        <div class="logo">
            <i class="fas fa-trophy" id="match-name"> 比分记录</i>

            <!-- 当前时间显示 -->
            <div class="current-time" id="current-time" style="zoom:0.7;display: none;">
                <i class="fas fa-clock"></i>
                <span id="current-time-display">00:00:00</span>
            </div>

            <!-- 模式切换按钮 -->
            <div class="top-controls hidden">
                <button class="mode-toggle compact-toggle hidden" style="zoom:0.8;" id="compact-toggle">
                    <i class="fas fa-compress-alt"></i>
                    <span>精简模式</span>
                </button>
                <button class="mode-toggle landscape-toggle" style="zoom:0.8;" id="landscape-toggle">
                    <i class="fas fa-rotate"></i>
                    <span>横屏模式</span>
                </button>
                <button class="fullscreen-toggle" style="zoom:0.8;" id="fullscreen-toggle">
                    <i class="fas fa-expand"></i>
                    <span>全屏模式</span>
                </button>
            </div>
        </div>
        <h1 class="hidden">真实比分记录板</h1>
        <p class="subtitle hidden">专业运动比赛比分记录 - 模拟真实比分牌风格</p>
    </header>

    <div class="main-content">
        <div class="left-panel">
            <div class="scoreboard-container">
                <!-- 队伍1比分板 -->
                <div class="team-scoreboard team1">
                    <div class="team-header">
                        <h2 class="team-title" id="team1-name">主队</h2>
                        <div class="team-color-indicator" style="width: 20px; height: 20px; background-color: #ff3333; border-radius: 50%;"></div>
                    </div>
                    <div class="score" id="team1-score">0</div>

                    <div class="team-stats">
                        <div class="stat-item">
                            <div class="stat-label">犯规次数</div>
                            <div class="stat-value" id="team1-fouls">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">暂停次数</div>
                            <div class="stat-value" id="team1-timeouts">0</div>
                        </div>
                    </div>

                    <div class="foul-controls">
                        <button class="foul-btn add-foul-btn" data-team="1" data-type="foul">
                            <i class="fas fa-plus hidden"></i>
                            <span>犯规+1</span>
                        </button>
                        <button class="foul-btn remove-foul-btn" data-team="1" data-type="foul">
                            <i class="fas fa-minus hidden"></i>
                            <span>犯规-1</span>
                        </button>
                        <button class="foul-btn add-foul-btn" data-team="1" data-type="timeout">
                            <i class="fas fa-clock hidden"></i>
                            <span>暂停+1</span>
                        </button>
                    </div>

                    <div class="score-controls">
                        <button class="score-btn add-btn" data-team="1" data-points="1">
                            <i class="fas fa-plus hidden"></i>
                            <span>+1 分</span>
                        </button>
                        <button class="score-btn add-btn" data-team="1" data-points="2">
                            <i class="fas fa-plus hidden"></i>
                            <span>+2 分</span>
                        </button>
                        <button class="score-btn add-btn" data-team="1" data-points="3">
                            <i class="fas fa-plus hidden"></i>
                            <span>+3 分</span>
                        </button>
                        <button class="score-btn subtract-btn" data-team="1" data-points="1">
                            <i class="fas fa-minus hidden"></i>
                            <span>-1 分</span>
                        </button>
                        <button class="score-btn reset-btn" data-team="1">
                            <i class="fas fa-redo">重置</i>
                            <span class="hidden">重置</span>
                        </button>
                    </div>
                </div>

                <!-- 队伍2比分板 -->
                <div class="team-scoreboard team2">
                    <div class="team-header">
                        <h2 class="team-title" id="team2-name">客队</h2>
                        <div class="team-color-indicator" style="width: 20px; height: 20px; background-color: #3366ff; border-radius: 50%;"></div>
                    </div>
                    <div class="score" id="team2-score">0</div>

                    <div class="team-stats">
                        <div class="stat-item">
                            <div class="stat-label">犯规次数</div>
                            <div class="stat-value" id="team2-fouls">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">暂停次数</div>
                            <div class="stat-value" id="team2-timeouts">0</div>
                        </div>
                    </div>

                    <div class="foul-controls">
                        <button class="foul-btn add-foul-btn" data-team="2" data-type="foul">
                            <i class="fas fa-plus hidden"></i>
                            <span>犯规+1</span>
                        </button>
                        <button class="foul-btn remove-foul-btn" data-team="2" data-type="foul">
                            <i class="fas fa-minus hidden"></i>
                            <span>犯规-1</span>
                        </button>
                        <button class="foul-btn add-foul-btn" data-team="2" data-type="timeout">
                            <i class="fas fa-clock hidden"></i>
                            <span>暂停+1</span>
                        </button>
                    </div>

                    <div class="score-controls">
                        <button class="score-btn add-btn" data-team="2" data-points="1">
                            <i class="fas fa-plus hidden"></i>
                            <span>+1 分</span>
                        </button>
                        <button class="score-btn add-btn" data-team="2" data-points="2">
                            <i class="fas fa-plus hidden"></i>
                            <span>+2 分</span>
                        </button>
                        <button class="score-btn add-btn" data-team="2" data-points="3">
                            <i class="fas fa-plus hidden"></i>
                            <span>+3 分</span>
                        </button>
                        <button class="score-btn subtract-btn" data-team="2" data-points="1">
                            <i class="fas fa-minus hidden"></i>
                            <span>-1 分</span>
                        </button>
                        <button class="score-btn reset-btn" data-team="2">
                            <i class="fas fa-redo">重置</i>
                            <span class="hidden">重置</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 比分趋势图表 -->
            <div class="chart-panel">
                <h2><i class="fas fa-chart-line"></i> 比分趋势图表</h2>
                <div class="chart-container">
                    <canvas id="score-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- 控制面板 -->
            <div class="control-panel">
                <div class="control-panel-header">
                    <h2><i class="fas fa-cog"></i> 比赛控制面板</h2>
                </div>
                <div class="control-panel-content">
                    <div class="mode-controls">
                        <div class="mode-control">
                            <span class="mode-label">精简模式</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="compact-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="mode-control">
                            <span class="mode-label">显示时间</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="time-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="mode-control">
                            <span class="mode-label">横屏模式</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="landscape-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="mode-control">
                            <span class="mode-label">全屏模式</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="fullscreen-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="match-period compact-item">
                        <div class="period-label">当前节次：</div>
                        <div class="period-controls">
                            <button class="period-btn active" data-period="1">第1节</button>
                            <button class="period-btn" data-period="2">第2节</button>
                            <button class="period-btn" data-period="3">第3节</button>
                            <button class="period-btn" data-period="4">第4节</button>
                            <button class="period-btn" data-period="ot">加时</button>
                        </div>
                    </div>

                    <div class="match-info">
                        <div class="match-info-item hidden">
                            <label for="sport-type">比赛类型：</label>
                            <select id="sport-type">
                                <option value="basketball">篮球</option>
                                <option value="football">足球</option>
                                <option value="volleyball">排球</option>
                                <option value="tennis">网球</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="match-info-item">
                            <label for="team1-input">比赛名称：</label>
                            <input type="text" id="match-name-input" value="比分记录" maxlength="30">
                        </div>
                        <div class="match-info-item">
                            <label for="team1-input">主队名称：</label>
                            <input type="text" id="team1-input" value="主队" maxlength="20">
                        </div>
                        <div class="match-info-item">
                            <label for="team2-input">客队名称：</label>
                            <input type="text" id="team2-input" value="客队" maxlength="20">
                        </div>
                        <div class="match-info-item compact-item">
                            <label for="max-fouls">犯规上限：</label>
                            <input type="number" id="max-fouls" min="0" max="50" value="5">
                        </div>
                        <div class="match-info-item compact-item">
                            <label for="max-timeouts">暂停上限：</label>
                            <input type="number" id="max-timeouts" min="0" max="20" value="3">
                        </div>
                    </div>
                    <div class="global-controls">
                        <button class="global-btn reset-all-btn" id="reset-all">
                            <i class="fas fa-sync-alt"></i>
                            重置全部
                        </button>
                        <button class="global-btn history-btn" id="show-history">
                            <i class="fas fa-history"></i>
                            比分历史
                        </button>
                        <button class="global-btn export-btn" id="export-data">
                            <i class="fas fa-download"></i>
                            导出数据
                        </button>
                        <button class="global-btn" id="clear-storage" style="background: linear-gradient(to bottom, #774477, #552255);">
                            <i class="fas fa-trash-alt"></i>
                            清除保存
                        </button>
                    </div>
                </div>
            </div>

            <!-- 比分历史记录 -->
            <div class="score-history" id="history-panel">
                <h2><i class="fas fa-history"></i> 比分历史记录</h2>
                <table class="history-table">
                    <thead>
                    <tr>
                        <th>时间</th>
                        <th>节次</th>
                        <th>事件</th>
                        <th id="history-team1">主队</th>
                        <th id="history-team2">客队</th>
                    </tr>
                    </thead>
                    <tbody id="history-body">
                    <!-- 历史记录将通过JavaScript动态添加 -->
                    </tbody>
                </table>
                <div id="empty-history-message" class="empty-history">暂无历史记录，开始调整比分来记录吧！</div>
                <button class="clear-history-btn" id="clear-history">
                    <i class="fas fa-trash"></i> 清除历史记录
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p>© 运动家 | 比赛比分记录</p>
    </footer>
</div>

<!-- 自定义确认框 -->
<div id="confirmDiv">

</div>

<script>
    // 初始化变量
    let team1Score = 0;
    let team2Score = 0;
    let team1Fouls = 0;
    let team2Fouls = 0;
    let team1Timeouts = 0;
    let team2Timeouts = 0;
    let currentPeriod = 1;
    let scoreHistory = [];
    let historyVisible = false;
    let scoreChart = null;
    let chartData = {
        labels: ["比赛开始"],
        team1Scores: [0],
        team2Scores: [0]
    };
    let isFullscreen = false;
    let compactMode = false;
    let timeMode = false;
    let landscapeMode = false;
    let autoSaveTimeout = null;

    // 使用jQuery缓存DOM元素
    const $currentTimeDivElement = $('#current-time');
    const $currentTimeElement = $('#current-time-display');
    const $fullscreenToggle = $('#fullscreen-toggle');
    const $team1ScoreElement = $('#team1-score');
    const $team2ScoreElement = $('#team2-score');
    const $team1FoulsElement = $('#team1-fouls');
    const $team2FoulsElement = $('#team2-fouls');
    const $team1TimeoutsElement = $('#team1-timeouts');
    const $team2TimeoutsElement = $('#team2-timeouts');
    const $matchNameElement = $('#match-name');
    const $team1NameElement = $('#team1-name');
    const $team2NameElement = $('#team2-name');
    const $matchNameInput = $('#match-name-input');
    const $team1Input = $('#team1-input');
    const $team2Input = $('#team2-input');
    const $historyTeam1Element = $('#history-team1');
    const $historyTeam2Element = $('#history-team2');
    const $historyBody = $('#history-body');
    const $historyPanel = $('#history-panel');
    const $emptyHistoryMessage = $('#empty-history-message');
    const $sportTypeSelect = $('#sport-type');
    const $maxFoulsInput = $('#max-fouls');
    const $maxTimeoutsInput = $('#max-timeouts');
    const $periodButtons = $('.period-btn');
    const $mainContainer = $('#main-container');
    const $compactToggle = $('#compact-toggle');
    const $landscapeToggle = $('#landscape-toggle');
    const $compactModeToggle = $('#compact-mode-toggle');
    const $timeModeToggle = $('#time-mode-toggle');
    const $landscapeModeToggle = $('#landscape-mode-toggle');
    const $fullscreenModeToggle = $('#fullscreen-mode-toggle');
    const $autoSaveIndicator = $('#auto-save-indicator');
    const $clearStorageBtn = $('#clear-storage');

    // 初始化
    $(document).ready(function() {
        // 从localStorage加载数据
        loadFromLocalStorage();

        // 初始化图表
        initScoreChart();

        // 初始化自定义确认框
        initConfirmDiv($('#confirmDiv'));

        // 为所有按钮添加事件监听器
        $('.score-btn').on('click', handleScoreButtonClick);
        $('.foul-btn').on('click', handleFoulButtonClick);

        // 节次按钮事件
        $periodButtons.on('click', function() {
            const period = $(this).data('period');
            setPeriod(period);
        });

        // 全局控制按钮
        $('#reset-all').on('click', resetAllBefore);
        $('#show-history').on('click', toggleHistoryPanel);
        $('#export-data').on('click', exportDataCSV);
        $('#clear-history').on('click', clearHistoryBefore);
        $clearStorageBtn.on('click', clearStorageBefore);

        // 队伍名称输入
        $matchNameInput.on('input', function() {
            updateMatchNames();
            saveToLocalStorage();
        });

        // 队伍名称输入
        $team1Input.on('input', function() {
            updateTeamNames();
            saveToLocalStorage();
        });
        $team2Input.on('input', function() {
            updateTeamNames();
            saveToLocalStorage();
        });

        // 运动类型选择
        $sportTypeSelect.on('change', function() {
            updateSportType();
            saveToLocalStorage();
        });

        // 犯规和暂停上限输入
        $maxFoulsInput.on('change', saveToLocalStorage);
        $maxTimeoutsInput.on('change', saveToLocalStorage);

        // 全屏按钮
        $fullscreenToggle.on('click', toggleFullscreenMode);

        // 模式切换按钮
        $compactToggle.on('click', toggleCompactMode);
        $landscapeToggle.on('click', toggleLandscapeMode);
        $compactModeToggle.on('change', toggleCompactMode);
        $timeModeToggle.on('change', toggleTimeMode);
        $landscapeModeToggle.on('change', toggleLandscapeMode);
        $fullscreenModeToggle.on('change', toggleFullscreenMode);

        // 更新历史表格中的队伍名称
        updateHistoryTeamNames();

        // 添加初始历史记录（如果还没有记录）
        if (scoreHistory.length === 0) {
            addHistoryEntry("比赛开始", 0, 0, 1);
        }

        // 启动时钟
        updateClock();
        setInterval(updateClock, 1000);

        // 监听全屏变化
        $(document).on('fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange', handleFullscreenChange);

        // 页面关闭前自动保存
        $(window).on('beforeunload', function() {
            saveToLocalStorage();
        });

        // 定期自动保存（每30秒）
        setInterval(saveToLocalStorage, 30000);
    });

    // 保存数据到localStorage
    function saveToLocalStorage() {
        try {
            const saveData = {
                version: '1.0',
                lastSaved: new Date().toISOString(),
                team1Score: team1Score,
                team2Score: team2Score,
                team1Fouls: team1Fouls,
                team2Fouls: team2Fouls,
                team1Timeouts: team1Timeouts,
                team2Timeouts: team2Timeouts,
                currentPeriod: currentPeriod,
                matchName: $matchNameInput.val(),
                team1Name: $team1NameElement.text(),
                team2Name: $team2NameElement.text(),
                sportType: $sportTypeSelect.val(),
                maxFouls: parseInt($maxFoulsInput.val()) || 5,
                maxTimeouts: parseInt($maxTimeoutsInput.val()) || 3,
                scoreHistory: scoreHistory,
                chartData: chartData,
                compactMode: compactMode,
                timeMode: timeMode,
                landscapeMode: landscapeMode
            };

            localStorage.setItem('scoreboardData', JSON.stringify(saveData));

            // 显示保存提示
            showAutoSaveIndicator();

            console.log('数据已保存到localStorage');
        } catch (error) {
            console.error('保存数据到localStorage失败:', error);
        }
    }

    // 从localStorage加载数据
    function loadFromLocalStorage() {
        try {
            const savedData = localStorage.getItem('scoreboardData');
            if (!savedData) {
                console.log('没有找到保存的数据');
                return;
            }

            const data = JSON.parse(savedData);

            // 检查版本（如果需要未来兼容性）
            if (data.version !== '1.0') {
                console.log('数据版本不匹配，使用默认值');
                return;
            }

            // 恢复数据
            team1Score = data.team1Score || 0;
            team2Score = data.team2Score || 0;
            team1Fouls = data.team1Fouls || 0;
            team2Fouls = data.team2Fouls || 0;
            team1Timeouts = data.team1Timeouts || 0;
            team2Timeouts = data.team2Timeouts || 0;
            currentPeriod = data.currentPeriod || 1;

            // 更新界面显示
            $team1ScoreElement.text(team1Score);
            $team2ScoreElement.text(team2Score);
            $team1FoulsElement.text(team1Fouls);
            $team2FoulsElement.text(team2Fouls);
            $team1TimeoutsElement.text(team1Timeouts);
            $team2TimeoutsElement.text(team2Timeouts);

            // 恢复比赛名称
            $matchNameInput.val(data.matchName || "比分记录");
            updateMatchNames();

            // 恢复队伍名称
            $team1Input.val(data.team1Name || "主队");
            $team2Input.val(data.team2Name || "客队");
            updateTeamNames();

            // 恢复运动类型
            $sportTypeSelect.val(data.sportType || "basketball");

            // 恢复设置
            $maxFoulsInput.val(data.maxFouls || 5);
            $maxTimeoutsInput.val(data.maxTimeouts || 3);

            // 恢复历史记录
            scoreHistory = data.scoreHistory || [];
            updateHistoryTable();

            // 恢复图表数据
            chartData = data.chartData || {
                labels: ["比赛开始"],
                team1Scores: [0],
                team2Scores: [0]
            };

            // 恢复模式设置
            if (data.compactMode) {
                toggleCompactMode();
            }
            if (data.timeMode) {
                toggleTimeMode();
            }
            if (data.landscapeMode) {
                toggleLandscapeMode();
            }

            // 恢复节次选择
            $periodButtons.removeClass('active');
            $(`.period-btn[data-period="${currentPeriod}"]`).addClass('active');

            console.log('从localStorage加载数据成功');
            addHistoryEntry("加载保存的数据", team1Score, team2Score, currentPeriod);
        } catch (error) {
            console.error('从localStorage加载数据失败:', error);
        }
    }

    // 清除localStorage数据
    function clearStorageBefore() {
        showConfirm(
            '清除保存的数据',
            '您确定要清除所有保存到本地的数据吗？此操作将删除所有自动保存的比赛数据。',
            function() {
                clearStorage();
            },
            function() {
                console.log('用户取消了清除操作');
            }
        );
    }

    function clearStorage() {
        try {
            localStorage.removeItem('scoreboardData');
            addHistoryEntry("清除本地保存的数据", team1Score, team2Score, currentPeriod);

            // 显示提示
            $autoSaveIndicator
                .html('<i class="fas fa-trash"></i><span>已清除保存的数据</span>')
                .css('background', 'linear-gradient(145deg, #552222, #331111)')
                .addClass('show');

            setTimeout(() => {
                $autoSaveIndicator.removeClass('show');
            }, 2000);

            console.log('localStorage数据已清除');
        } catch (error) {
            console.error('清除localStorage数据失败:', error);
        }
    }

    // 显示自动保存提示
    function showAutoSaveIndicator() {
        // 清除之前的定时器
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }

        // 恢复默认样式
        $autoSaveIndicator
            .html('<i class="fas fa-save"></i><span>数据已保存</span>')
            .css('background', 'linear-gradient(145deg, #225522, #113311)')
            .addClass('show');

        // 2秒后隐藏
        autoSaveTimeout = setTimeout(() => {
            $autoSaveIndicator.removeClass('show');
        }, 2000);
    }

    // 更新时钟显示
    function updateClock() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        $currentTimeElement.text(`${hours}:${minutes}:${seconds}`);
    }

    // 切换全屏模式
    function toggleFullscreenMode() {
        if (!isFullscreen) {
            // 进入全屏
            const element = document.documentElement;

            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }

            isFullscreen = true;
            $fullscreenToggle.addClass('active').html('<i class="fas fa-compress"></i><span>退出全屏</span>');
            $fullscreenModeToggle.prop('checked', true);
            addHistoryEntry("进入全屏模式", team1Score, team2Score, currentPeriod);
        } else {
            // 退出全屏
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }

            isFullscreen = false;
            $fullscreenToggle.removeClass('active').html('<i class="fas fa-expand"></i><span>全屏模式</span>');
            $fullscreenModeToggle.prop('checked', false);
            addHistoryEntry("退出全屏模式", team1Score, team2Score, currentPeriod);
        }

        // 保存设置
        saveToLocalStorage();
    }

    // 处理全屏变化
    function handleFullscreenChange() {
        const fullscreenElement =
            document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement;

        isFullscreen = !!fullscreenElement;

        if (isFullscreen) {
            $mainContainer.addClass('fullscreen-mode');
            $fullscreenToggle.addClass('active').html('<i class="fas fa-compress"></i><span>退出全屏</span>');
        } else {
            $mainContainer.removeClass('fullscreen-mode');
            $fullscreenToggle.removeClass('active').html('<i class="fas fa-expand"></i><span>全屏模式</span>');
        }
    }

    // 处理分数按钮点击
    function handleScoreButtonClick(event) {
        const $button = $(event.currentTarget);
        const team = $button.data('team');
        const points = parseInt($button.data('points')) || 0;

        // 判断是加分还是减分按钮
        if ($button.hasClass('add-btn')) {
            updateScore(team, points);
        } else if ($button.hasClass('subtract-btn')) {
            updateScore(team, -points);
        } else if ($button.hasClass('reset-btn')) {
            resetTeamScoreBefore(team);
        }

        // 添加动画效果
        const $scoreElement = team == '1' ? $team1ScoreElement : $team2ScoreElement;
        $scoreElement.addClass('pulse');
        setTimeout(() => {
            $scoreElement.removeClass('pulse');
        }, 500);

        // 保存数据
        saveToLocalStorage();
    }

    // 处理犯规按钮点击
    function handleFoulButtonClick(event) {
        const $button = $(event.currentTarget);
        const team = $button.data('team');
        const type = $button.data('type');

        if ($button.hasClass('add-foul-btn')) {
            if (type === 'foul') {
                updateFouls(team, 1);
            } else if (type === 'timeout') {
                updateTimeouts(team, 1);
            }
        } else if ($button.hasClass('remove-foul-btn')) {
            if (type === 'foul') {
                updateFouls(team, -1);
            }
        }

        // 保存数据
        saveToLocalStorage();
    }

    // 更新分数
    function updateScore(team, points) {
        let action = "";

        if (team == '1') {
            team1Score = Math.max(0, team1Score + points);
            $team1ScoreElement.text(team1Score);
            action = points > 0 ? `主队增加 ${points} 分` : `主队减少 ${Math.abs(points)} 分`;
        } else {
            team2Score = Math.max(0, team2Score + points);
            $team2ScoreElement.text(team2Score);
            action = points > 0 ? `客队增加 ${points} 分` : `客队减少 ${Math.abs(points)} 分`;
        }

        // 更新图表数据
        updateChartData();

        // 添加到历史记录
        addHistoryEntry(action, team1Score, team2Score, currentPeriod);
    }

    // 更新犯规次数
    function updateFouls(team, change) {
        const maxFouls = parseInt($maxFoulsInput.val()) || 5;

        if (team == '1') {
            team1Fouls = Math.max(0, Math.min(maxFouls, team1Fouls + change));
            $team1FoulsElement.text(team1Fouls);

            if (change > 0) {
                addHistoryEntry(`主队犯规+1 (${team1Fouls}/${maxFouls})`, team1Score, team2Score, currentPeriod);

                // 如果达到犯规上限，添加视觉提示
                if (team1Fouls >= maxFouls) {
                    $team1FoulsElement.addClass('blink');
                } else {
                    $team1FoulsElement.removeClass('blink');
                }
            }
        } else {
            team2Fouls = Math.max(0, Math.min(maxFouls, team2Fouls + change));
            $team2FoulsElement.text(team2Fouls);

            if (change > 0) {
                addHistoryEntry(`客队犯规+1 (${team2Fouls}/${maxFouls})`, team1Score, team2Score, currentPeriod);

                // 如果达到犯规上限，添加视觉提示
                if (team2Fouls >= maxFouls) {
                    $team2FoulsElement.addClass('blink');
                } else {
                    $team2FoulsElement.removeClass('blink');
                }
            }
        }
    }

    // 更新暂停次数
    function updateTimeouts(team, change) {
        const maxTimeouts = parseInt($maxTimeoutsInput.val()) || 3;

        if (team == '1') {
            team1Timeouts = Math.max(0, Math.min(maxTimeouts, team1Timeouts + change));
            $team1TimeoutsElement.text(team1Timeouts);

            if (change > 0) {
                addHistoryEntry(`主队暂停+1 (${team1Timeouts}/${maxTimeouts})`, team1Score, team2Score, currentPeriod);

                // 如果达到暂停上限，添加视觉提示
                if (team1Timeouts >= maxTimeouts) {
                    $team1TimeoutsElement.addClass('blink');
                } else {
                    $team1TimeoutsElement.removeClass('blink');
                }
            }
        } else {
            team2Timeouts = Math.max(0, Math.min(maxTimeouts, team2Timeouts + change));
            $team2TimeoutsElement.text(team2Timeouts);

            if (change > 0) {
                addHistoryEntry(`客队暂停+1 (${team2Timeouts}/${maxTimeouts})`, team1Score, team2Score, currentPeriod);

                // 如果达到暂停上限，添加视觉提示
                if (team2Timeouts >= maxTimeouts) {
                    $team2TimeoutsElement.addClass('blink');
                } else {
                    $team2TimeoutsElement.removeClass('blink');
                }
            }
        }
    }

    function resetTeamScoreBefore(team) {
        const teamName = team == '1' ? $team1NameElement.text() : $team2NameElement.text();
        showConfirm(
            '重置比赛数据',
            '您确定要重置' + teamName + '分数吗？此操作将清除当前比分。',
            function() {
                resetTeamScore(team);
                saveToLocalStorage();
            },
            function() {
                console.log('用户取消了重置操作');
            }
        );
    }

    // 重置队伍分数
    function resetTeamScore(team) {
        if (team == '1') {
            team1Score = 0;
            $team1ScoreElement.text('0');
        } else {
            team2Score = 0;
            $team2ScoreElement.text('0');
        }

        const teamName = team == '1' ? $team1NameElement.text() : $team2NameElement.text();
        addHistoryEntry(`${teamName} 分数重置`, team1Score, team2Score, currentPeriod);

        // 更新图表数据
        updateChartData();
    }

    function resetAllBefore() {
        showConfirm(
            '重置比赛数据',
            '您确定要重置所有数据吗？此操作将复位当前比赛所有数据。',
            function() {
                resetAll();
                saveToLocalStorage();
            },
            function() {
                console.log('用户取消了重置操作');
            }
        );
    }

    // 重置所有数据
    function resetAll() {
        team1Score = 0;
        team2Score = 0;
        team1Fouls = 0;
        team2Fouls = 0;
        team1Timeouts = 0;
        team2Timeouts = 0;

        $team1ScoreElement.text('0');
        $team2ScoreElement.text('0');
        $team1FoulsElement.text('0');
        $team2FoulsElement.text('0');
        $team1TimeoutsElement.text('0');
        $team2TimeoutsElement.text('0');

        // 移除闪烁效果
        $team1FoulsElement.removeClass('blink');
        $team2FoulsElement.removeClass('blink');
        $team1TimeoutsElement.removeClass('blink');
        $team2TimeoutsElement.removeClass('blink');

        // 重置图表数据
        chartData = {
            labels: ["比赛开始"],
            team1Scores: [0],
            team2Scores: [0]
        };
        updateChart();

        addHistoryEntry("重置所有数据", 0, 0, currentPeriod);
    }

    // 设置比赛节次
    function setPeriod(period) {
        // 移除所有节次按钮的active类
        $periodButtons.removeClass('active');

        // 为当前节次按钮添加active类
        $(`.period-btn[data-period="${period}"]`).addClass('active');

        // 更新当前节次
        currentPeriod = period;

        addHistoryEntry(`切换到第${period === 'ot' ? '加时' : period}节`, team1Score, team2Score, period);

        // 保存设置
        saveToLocalStorage();
    }

    // 切换精简模式
    function toggleCompactMode() {
        compactMode = !compactMode;

        if (compactMode) {
            $mainContainer.addClass('compact-mode');
            $compactToggle.addClass('active').html('<i class="fas fa-expand-alt"></i><span>标准模式</span>');
            $compactModeToggle.prop('checked', true);
            addHistoryEntry("切换到精简模式", team1Score, team2Score, currentPeriod);
        } else {
            $mainContainer.removeClass('compact-mode');
            $compactToggle.removeClass('active').html('<i class="fas fa-compress-alt"></i><span>精简模式</span>');
            $compactModeToggle.prop('checked', false);
            addHistoryEntry("切换到标准模式", team1Score, team2Score, currentPeriod);
        }

        // 保存设置
        saveToLocalStorage();
    }

    // 切换时间显示
    function toggleTimeMode() {
        timeMode = !timeMode;

        if (timeMode) {
            $currentTimeDivElement.show();
            $timeModeToggle.prop('checked', true);
            addHistoryEntry("切换到显示时间", team1Score, team2Score, currentPeriod);
        } else {
            $currentTimeDivElement.hide();
            $timeModeToggle.prop('checked', false);
            addHistoryEntry("切换到隐藏时间", team1Score, team2Score, currentPeriod);
        }

        // 保存设置
        saveToLocalStorage();
    }

    // 切换横屏模式
    function toggleLandscapeMode() {
        landscapeMode = !landscapeMode;

        if (landscapeMode) {
            $mainContainer.addClass('landscape-mode');
            $landscapeToggle.addClass('active').html('<i class="fas fa-undo"></i><span>竖屏模式</span>');
            $landscapeModeToggle.prop('checked', true);
            addHistoryEntry("切换到横屏模式", team1Score, team2Score, currentPeriod);
        } else {
            $mainContainer.removeClass('landscape-mode');
            $landscapeToggle.removeClass('active').html('<i class="fas fa-rotate"></i><span>横屏模式</span>');
            $landscapeModeToggle.prop('checked', false);
            addHistoryEntry("切换到竖屏模式", team1Score, team2Score, currentPeriod);
        }

        // 保存设置
        saveToLocalStorage();
    }

    // 初始化比分趋势图表
    function initScoreChart() {
        const ctx = document.getElementById('score-chart').getContext('2d');
        scoreChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: $team1NameElement.text(),
                        data: chartData.team1Scores,
                        borderColor: '#ff3333',
                        backgroundColor: 'rgba(255, 51, 51, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: $team2NameElement.text(),
                        data: chartData.team2Scores,
                        borderColor: '#3366ff',
                        backgroundColor: 'rgba(51, 102, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#cccccc',
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#cccccc'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#cccccc'
                        }
                    }
                }
            }
        });
    }

    // 更新图表数据
    function updateChartData() {
        const now = new Date();
        const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

        chartData.labels.push(timeString);
        chartData.team1Scores.push(team1Score);
        chartData.team2Scores.push(team2Score);

        // 限制数据点数量
        if (chartData.labels.length > 20) {
            chartData.labels.shift();
            chartData.team1Scores.shift();
            chartData.team2Scores.shift();
        }

        updateChart();
    }

    // 更新图表
    function updateChart() {
        if (scoreChart) {
            scoreChart.data.labels = chartData.labels;
            scoreChart.data.datasets[0].data = chartData.team1Scores;
            scoreChart.data.datasets[0].label = $team1NameElement.text();
            scoreChart.data.datasets[1].data = chartData.team2Scores;
            scoreChart.data.datasets[1].label = $team2NameElement.text();
            scoreChart.update();
        }
    }

    // 添加历史记录
    function addHistoryEntry(action, score1, score2, period) {
        const now = new Date();
        const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

        const periodText = period === 'ot' ? '加时' : `第${period}节`;

        const historyEntry = {
            time: timeString,
            period: periodText,
            action: action,
            team1Score: score1,
            team2Score: score2
        };

        scoreHistory.unshift(historyEntry); // 添加到开头

        // 限制历史记录数量
        if (scoreHistory.length > 50) {
            scoreHistory.pop();
        }

        updateHistoryTable();
    }

    // 更新历史记录表格
    function updateHistoryTable() {
        // 清空表格
        $historyBody.empty();

        if (scoreHistory.length === 0) {
            $emptyHistoryMessage.show();
            return;
        }

        $emptyHistoryMessage.hide();

        // 添加历史记录行
        scoreHistory.forEach(entry => {
            const $row = $('<tr></tr>');

            const $timeCell = $('<td></td>').text(entry.time);
            const $periodCell = $('<td></td>').text(entry.period);
            const $actionCell = $('<td></td>').text(entry.action);
            const $score1Cell = $('<td></td>').text(entry.team1Score).css({color: '#ff3333', fontWeight: 'bold'});
            const $score2Cell = $('<td></td>').text(entry.team2Score).css({color: '#3366ff', fontWeight: 'bold'});

            $row.append($timeCell, $periodCell, $actionCell, $score1Cell, $score2Cell);
            $historyBody.append($row);
        });
    }

    // 切换历史记录面板显示
    function toggleHistoryPanel() {
        historyVisible = !historyVisible;

        if (historyVisible) {
            $historyPanel.show();
            $('#show-history').html('<i class="fas fa-eye-slash"></i> 隐藏历史');
        } else {
            $historyPanel.hide();
            $('#show-history').html('<i class="fas fa-history"></i> 比分历史');
        }
    }

    function clearHistoryBefore() {
        if (scoreHistory.length === 0) return;

        showConfirm(
            '清除历史记录',
            '您确定要清除所有历史记录吗？',
            function() {
                clearHistory();
                saveToLocalStorage();
            },
            function() {
                console.log('用户取消了清除操作');
            }
        );
    }

    // 清除历史记录
    function clearHistory() {
        scoreHistory = [];
        updateHistoryTable();
        addHistoryEntry("历史记录已清除", team1Score, team2Score, currentPeriod);
    }

    // 导出数据
    function exportData() {
        const exportData = {
            matchInfo: {
                team1: $team1NameElement.text(),
                team2: $team2NameElement.text(),
                sportType: $sportTypeSelect.find('option:selected').text(),
                currentPeriod: currentPeriod,
                timestamp: new Date().toISOString()
            },
            scores: {
                team1: team1Score,
                team2: team2Score,
                team1Fouls: team1Fouls,
                team2Fouls: team2Fouls,
                team1Timeouts: team1Timeouts,
                team2Timeouts: team2Timeouts
            },
            history: scoreHistory,
            chartData: chartData
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

        const exportFileDefaultName = `scoreboard_${$team1NameElement.text()}_vs_${$team2NameElement.text()}_${new Date().toISOString().slice(0, 10)}.json`;

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();

        addHistoryEntry("导出比赛数据", team1Score, team2Score, currentPeriod);
    }

    // CSV导出功能
    function exportDataCSV() {
        const mockData = {
            matchInfo: {
                team1: $team1NameElement.text(),
                team2: $team2NameElement.text(),
                sportType: $sportTypeSelect.find('option:selected').text(),
                currentPeriod: currentPeriod,
                timestamp: new Date().toISOString()
            },
            scores: {
                team1: team1Score,
                team2: team2Score,
                team1Fouls: team1Fouls,
                team2Fouls: team2Fouls,
                team1Timeouts: team1Timeouts,
                team2Timeouts: team2Timeouts
            },
            history: scoreHistory,
            chartData: chartData
        };
        const data = mockData;

        // 创建CSV内容
        let csvContent = "";

        // 1. 添加UTF-8 BOM（确保Excel正确显示中文）
        csvContent = '\ufeff';

        // 2. 添加比赛基本信息
        csvContent += "比赛基本信息\n";
        csvContent += "字段,值\n";
        csvContent += `主队,${data.matchInfo.team1}\n`;
        csvContent += `客队,${data.matchInfo.team2}\n`;
        csvContent += `比赛时间,${new Date(data.matchInfo.timestamp).toLocaleString('zh-CN')}\n`;
        csvContent += `最终比分,${data.scores.team1}-${data.scores.team2}\n`;
        csvContent += data.team1Fouls?`主队犯规,${data.team1Fouls}\n`:'';
        csvContent += data.team2Fouls?`客队犯规,${data.team2Fouls}\n`:'';
        csvContent += data.team1Timeouts?`主队暂停,${data.team1Timeouts}\n`:'';
        csvContent += data.team2Timeouts?`客队暂停,${data.team2Timeouts}\n`:'';
        csvContent += data.matchInfo.maxFouls?`犯规上限,${data.matchInfo.maxFouls}\n`:'';
        csvContent += data.matchInfo.maxTimeouts?`暂停上限,${data.matchInfo.maxTimeouts}\n`:'';

        // 3. 添加一个空行
        csvContent += "\n";

        // 4. 添加历史记录
        csvContent += "历史记录\n";
        csvContent += "时间,节次,事件,主队得分,客队得分\n";
        data.history.forEach(entry => {
            // 处理CSV特殊字符（如逗号、引号、换行符）
            const safeTime = entry.time.replace(/"/g, '""');
            const safePeriod = entry.period.replace(/"/g, '""');
            const safeAction = entry.action.replace(/"/g, '""');

            csvContent += `"${safeTime}","${safePeriod}","${safeAction}",${entry.team1Score},${entry.team2Score}\n`;
        });

        // 5. 添加一个空行
        csvContent += "\n";

        // 6. 添加图表数据
        csvContent += "比分趋势数据\n";
        csvContent += "时间,主队得分,客队得分,分差\n";

        for (let i = 0; i < data.chartData.labels.length; i++) {
            const time = data.chartData.labels[i];
            const team1Score = data.chartData.team1Scores[i] || 0;
            const team2Score = data.chartData.team2Scores[i] || 0;
            const pointDifference = team1Score - team2Score;

            csvContent += `${time},${team1Score},${team2Score},${pointDifference}\n`;
        }

        // 创建下载链接
        const fileName = `比分记录_${data.matchInfo.team1}_vs_${data.matchInfo.team2}_${new Date().toISOString().slice(0, 10)}.csv`;

        // 创建Blob对象
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

        // 创建下载链接
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert('您的浏览器不支持此导出功能，请使用Chrome、Firefox或Edge浏览器。');
        }

        addHistoryEntry("导出比赛数据", team1Score, team2Score, currentPeriod);

        return csvContent;
    }

    // 更新比赛名称
    function updateMatchNames() {
        const matchName = $matchNameInput.val() || "比分记录";

        $matchNameElement.text(" "+matchName);

        addHistoryEntry(`比赛名称更新: ${matchName}`, team1Score, team2Score, currentPeriod);
    }

    // 更新队伍名称
    function updateTeamNames() {
        const team1Name = $team1Input.val() || "主队";
        const team2Name = $team2Input.val() || "客队";

        $team1NameElement.text(team1Name);
        $team2NameElement.text(team2Name);

        updateHistoryTeamNames();
        updateChart();

        addHistoryEntry(`队伍名称更新: ${team1Name} vs ${team2Name}`, team1Score, team2Score, currentPeriod);
    }

    // 更新历史记录表格中的队伍名称
    function updateHistoryTeamNames() {
        $historyTeam1Element.text($team1NameElement.text());
        $historyTeam2Element.text($team2NameElement.text());
    }

    // 根据运动类型更新界面
    function updateSportType() {
        const sportType = $sportTypeSelect.val();
        let team1Default, team2Default;

        switch(sportType) {
            case 'basketball':
                team1Default = "湖人队";
                team2Default = "凯尔特人队";
                if (compactMode){
                    $compactModeToggle.click();
                }
                // 设置篮球默认值
                $maxFoulsInput.val(5);
                $maxTimeoutsInput.val(3);
                break;
            case 'football':
                team1Default = "巴西队";
                team2Default = "德国队";
                if (!compactMode){
                    $compactModeToggle.click();
                }
                $maxFoulsInput.val(5);
                $maxTimeoutsInput.val(3);
                break;
            case 'volleyball':
                team1Default = "中国队";
                team2Default = "美国队";
                if (!compactMode){
                    $compactModeToggle.click();
                }
                $maxFoulsInput.val(0);
                $maxTimeoutsInput.val(2);
                break;
            case 'tennis':
                team1Default = "纳达尔";
                team2Default = "费德勒";
                if (!compactMode){
                    $compactModeToggle.click();
                }
                $maxFoulsInput.val(0);
                $maxTimeoutsInput.val(0);
                break;
            default:
                team1Default = "主队";
                team2Default = "客队";
        }

        if (sportType !== 'custom') {
            $team1Input.val(team1Default);
            $team2Input.val(team2Default);
            updateTeamNames();
        }
    }

    // 添加键盘快捷键支持
    $(document).on('keydown', function(event) {
        // 数字键1-3为队伍1加分
        if (event.key >= '1' && event.key <= '3') {
            const points = parseInt(event.key);
            updateScore('1', points);
            $team1ScoreElement.addClass('pulse');
            setTimeout(() => {
                $team1ScoreElement.removeClass('pulse');
            }, 500);

            // 保存数据
            saveToLocalStorage();
        }

        // 数字键7-9为队伍2加分
        if (event.key >= '7' && event.key <= '9') {
            const points = parseInt(event.key) - 6; // 7->1, 8->2, 9->3
            updateScore('2', points);
            $team2ScoreElement.addClass('pulse');
            setTimeout(() => {
                $team2ScoreElement.removeClass('pulse');
            }, 500);

            // 保存数据
            saveToLocalStorage();
        }

        // R键重置所有分数
        if (event.key === 'r' || event.key === 'R') {
            resetAll();
            saveToLocalStorage();
        }

        // H键显示/隐藏历史记录
        if (event.key === 'h' || event.key === 'H') {
            toggleHistoryPanel();
        }

        // C键切换精简模式
        if (event.key === 'c' || event.key === 'C') {
            toggleCompactMode();
        }

        // L键切换横屏模式
        if (event.key === 'l' || event.key === 'L') {
            toggleLandscapeMode();
        }
    });
</script>
</body>
</html>